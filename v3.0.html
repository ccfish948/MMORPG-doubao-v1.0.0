<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¾æ—ç´€å…ƒ Â· å®Œæ•´2DéŠæˆ²</title>
    <style>
        /* === å…¨å±€æ¨£å¼ï¼šæ¥µç°¡æš—è‰²éŠæˆ²é¢¨æ ¼ === */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: #0a0c0f;
            font-family: 'Segoe UI', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            color: #e0d9c8;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #game-container {
            width: 1300px;
            max-width: 100%;
            background: #1a1e24;
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.8), inset 0 1px 2px rgba(255,255,240,0.05);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border: 1px solid #3a404b;
        }

        /* é ‚éƒ¨ç‹€æ…‹æ¬„ */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #0f1319;
            border-radius: 40px;
            padding: 8px 20px;
            border: 1px solid #2f3540;
            font-size: 0.95rem;
            color: #b9c7d9;
        }

        .user-info span {
            margin-right: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .user-info span:hover { color: #ffd966; }

        .game-actions button {
            background: none;
            border: 1px solid #4f5b68;
            color: #d4dcec;
            padding: 6px 16px;
            margin-left: 12px;
            border-radius: 30px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .game-actions button:hover {
            background: #2f3a47;
            border-color: #8a9bb5;
            color: #ffffff;
        }

        /* ä¸»å€åŸŸï¼šå·¦å´ç•«å¸ƒ + å³å´é¢æ¿ */
        .main-area {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        #game-canvas {
            flex: 2;
            min-width: 500px;
            background: #11151c;
            border-radius: 20px;
            box-shadow: inset 0 0 20px #000000;
            border: 2px solid #363e4a;
            image-rendering: crisp-edges; /* åƒç´ é¢¨æ ¼æ„Ÿ */
            display: block;
        }

        .right-panel {
            flex: 1;
            min-width: 280px;
            background: #151b23;
            border-radius: 20px;
            padding: 20px;
            border: 1px solid #3c4552;
            box-shadow: 0 10px 20px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-section {
            background: #1e2630;
            border-radius: 16px;
            padding: 16px;
            border-left: 4px solid #6c8ebf;
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #e9d7a3;
            letter-spacing: 1px;
            border-bottom: 1px dashed #4b5a6b;
            padding-bottom: 6px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-item {
            background: #131a22;
            border-radius: 12px;
            padding: 8px 10px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            border: 1px solid #334152;
        }

        .stat-label { color: #a3b8d0; }
        .stat-value { color: #f5e6b3; font-weight: 600; }

        /* è¨»å†Š/ç™»å…¥æµ®å±¤ */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.3s;
        }
        .modal.hidden { display: none; }

        .modal-card {
            background: #1e262f;
            border-radius: 32px;
            padding: 32px;
            width: 380px;
            border: 2px solid #566f8f;
            box-shadow: 0 30px 50px rgba(0,0,0,0.9);
            text-align: center;
        }

        .modal-card h2 {
            font-size: 2rem;
            color: #dbbc7c;
            margin-bottom: 24px;
            font-weight: 400;
            text-shadow: 0 2px 5px #000;
        }

        .input-field {
            width: 100%;
            padding: 14px 18px;
            margin: 12px 0;
            background: #0f151d;
            border: 2px solid #38495e;
            border-radius: 40px;
            font-size: 1rem;
            color: #f0e6d2;
            outline: none;
            transition: 0.2s;
        }
        .input-field:focus { border-color: #b5945a; }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 40px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            background: #384b60;
            color: #e6dccb;
        }
        .modal-btn.primary {
            background: #7a5f3a;
            color: #fff4e2;
            box-shadow: 0 5px 0 #4d3b24;
        }
        .modal-btn.primary:hover { background: #8f734b; transform: translateY(-2px); box-shadow: 0 7px 0 #4d3b24; }
        .modal-btn.secondary:hover { background: #4f637b; }

        .error-msg {
            color: #f77;
            margin-top: 16px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
<div id="game-container">
    <!-- é ‚éƒ¨ç‹€æ…‹æ¬„ -->
    <div class="status-bar">
        <div class="user-info">
            <span id="display-username">æœªç™»å…¥</span>
            <span id="player-level">Lv.1</span>
            <span>ç¶“é©—: 0/100</span>
        </div>
        <div class="game-actions">
            <button id="save-game">ğŸ“¥ å­˜æª”</button>
            <button id="load-game">ğŸ“¤ è¼‰å…¥</button>
            <button id="logout-btn">ğŸšª ç™»å‡º</button>
        </div>
    </div>

    <!-- ä¸»è¦éŠæˆ²å€åŸŸ -->
    <div class="main-area">
        <canvas id="game-canvas" width="720" height="480"></canvas>
        <div class="right-panel">
            <div class="panel-section">
                <div class="panel-title">âš”ï¸ æ ¸å¿ƒå±¬æ€§</div>
                <div class="stat-grid" id="stats-container">
                    <!-- ç”±JSå‹•æ…‹å¡«å…¥ -->
                </div>
            </div>
            <div class="panel-section">
                <div class="panel-title">ğŸ“¦ å¿«é€Ÿè£å‚™</div>
                <div id="quick-equip">æ­¦å™¨: ç„¡</div>
                <!-- æ›´å¤šè£å‚™ç°¡æ˜“é¡¯ç¤º -->
            </div>
            <div class="panel-section">
                <div class="panel-title">ğŸ‰ ç•¶å‰æˆ°é¬¥</div>
                <button id="quick-battle-btn" style="width:100%; padding:12px; background:#5f4e3c; border:none; border-radius:30px; color:white; font-size:1.1rem;">â–¶ å¿«é€Ÿæˆ°é¬¥ (PVE)</button>
            </div>
        </div>
    </div>
</div>

<!-- ç™»å…¥/è¨»å†Š Modal (é è¨­é¡¯ç¤º) -->
<div id="auth-modal" class="modal">
    <div class="modal-card">
        <h2>é¾æ—ç´€å…ƒ</h2>
        <input type="text" id="auth-username" class="input-field" placeholder="å¸³è™Ÿ" autocomplete="off">
        <input type="password" id="auth-password" class="input-field" placeholder="å¯†ç¢¼">
        <div class="modal-actions">
            <button class="modal-btn primary" id="login-btn">ç™»å…¥</button>
            <button class="modal-btn secondary" id="register-btn">è¨»å†Š</button>
        </div>
        <div id="auth-message" class="error-msg"></div>
        <div style="margin-top:16px; font-size:0.8rem; color:#6f7b8a;">ç®¡ç†å“¡: root / root</div>
    </div>
</div>

<script>
    // ==================== å…¨åŸŸ Game ç‰©ä»¶ ====================
    window.Game = (function() {
        // ---------- æ ¸å¿ƒç‹€æ…‹ ----------
        let currentUser = null;               // { username, passwordHash? å¯¦éš›åªå­˜æ˜æ–‡æ–¹ä¾¿demoï¼Œæ­£å¼æ‡‰hashï¼Œä½†æ­¤ç‚ºç¯„ä¾‹ }
        let playerData = null;                // ç©å®¶å­˜æª”æ•¸æ“š (ç­‰ç´šã€ç¶“é©—ã€å±¬æ€§ã€è£å‚™ç­‰)

        // ---------- æœ¬åœ°å­˜å„²éµ ----------
        const STORAGE_USERS = 'dragon_age_users';      // æ‰€æœ‰è¨»å†Šç”¨æˆ¶åˆ—è¡¨
        const STORAGE_PREFIX = 'dragon_age_save_';     // æ¯å€‹ç”¨æˆ¶å­˜æª”å‰ç¶´

        // ---------- é è¨­ç®¡ç†å“¡ ----------
        function initDefaultAdmin() {
            let users = loadUsers();
            if (!users.find(u => u.username === 'root')) {
                users.push({ username: 'root', password: 'root' });  // åƒ…æ¼”ç¤ºï¼Œå‹¿ç”¨æ–¼ç”Ÿç”¢
                saveUsers(users);
            }
        }

        // ç”¨æˆ¶åˆ—è¡¨å­˜å–
        function loadUsers() {
            const data = localStorage.getItem(STORAGE_USERS);
            return data ? JSON.parse(data) : [];
        }

        function saveUsers(users) {
            localStorage.setItem(STORAGE_USERS, JSON.stringify(users));
        }

        // ä¿å­˜ç•¶å‰ç”¨æˆ¶å­˜æª”
        function savePlayerData(username, data) {
            if (!username) return;
            localStorage.setItem(STORAGE_PREFIX + username, JSON.stringify(data));
        }

        function loadPlayerData(username) {
            const data = localStorage.getItem(STORAGE_PREFIX + username);
            return data ? JSON.parse(data) : null;
        }

        // å‰µå»ºæ–°ç©å®¶åˆå§‹æ•¸æ“š
        function createNewPlayerData() {
            return {
                level: 1,
                exp: 0,
                expNext: 100,
                attributes: {
                    attack: 12,
                    defense: 8,
                    magicDefense: 6,
                    hit: 90,
                    dodge: 5,
                    critRate: 5,
                    critDamage: 150,
                    critResist: 0
                },
                equipment: {},       // ç©¿æˆ´çš„è£å‚™
                inventory: [],       // èƒŒåŒ…
                // å¾ŒçºŒæœƒæ“´å……æ›´å¤š
            };
        }

        // ---------- ç™»å…¥/è¨»å†Šé‚è¼¯ ----------
        function register(username, password) {
            if (!username || !password) return { success: false, msg: 'å¸³è™Ÿå¯†ç¢¼ä¸å¯ç©ºç™½' };
            let users = loadUsers();
            if (users.find(u => u.username === username)) {
                return { success: false, msg: 'å¸³è™Ÿå·²å­˜åœ¨' };
            }
            users.push({ username, password }); // æ¼”ç¤ºæ˜æ–‡
            saveUsers(users);
            // å‰µå»ºåˆå§‹å­˜æª”
            const newData = createNewPlayerData();
            savePlayerData(username, newData);
            return { success: true, msg: 'è¨»å†ŠæˆåŠŸ' };
        }

        function login(username, password) {
            if (!username || !password) return { success: false, msg: 'è¼¸å…¥å¸³è™Ÿå¯†ç¢¼' };
            let users = loadUsers();
            const user = users.find(u => u.username === username && u.password === password);
            if (!user) return { success: false, msg: 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤' };
            // è¼‰å…¥ç©å®¶æ•¸æ“š
            let data = loadPlayerData(username);
            if (!data) {
                data = createNewPlayerData(); // è‹¥ç„¡å‰‡æ–°å»º
                savePlayerData(username, data);
            }
            currentUser = { username };
            playerData = data;
            return { success: true, msg: 'ç™»å…¥æˆåŠŸ' };
        }

        function logout() {
            if (currentUser) {
                savePlayerData(currentUser.username, playerData); // å…ˆå­˜æª”
                currentUser = null;
                playerData = null;
            }
            showAuthModal(true);
            updateUIForUser();
        }

        // ---------- UI æ›´æ–° ----------
        function updateUIForUser() {
            const usernameSpan = document.getElementById('display-username');
            const levelSpan = document.getElementById('player-level');
            if (currentUser && playerData) {
                usernameSpan.textContent = currentUser.username;
                levelSpan.textContent = `Lv.${playerData.level}`;
                document.getElementById('quick-equip').innerHTML = `æ­¦å™¨: ${playerData.equipment?.weapon?.name || 'ç„¡'}`;
                // æ›´æ–°å±¬æ€§é¢æ¿
                updateStatsPanel();
            } else {
                usernameSpan.textContent = 'æœªç™»å…¥';
                levelSpan.textContent = 'Lv.1';
            }
        }

        function updateStatsPanel() {
            const container = document.getElementById('stats-container');
            if (!playerData) {
                container.innerHTML = '<div class="stat-item">è«‹å…ˆç™»å…¥</div>';
                return;
            }
            const attr = playerData.attributes;
            const html = `
                <div class="stat-item"><span class="stat-label">æ”»æ“Š</span><span class="stat-value">${attr.attack}</span></div>
                <div class="stat-item"><span class="stat-label">ç‰©é˜²</span><span class="stat-value">${attr.defense}</span></div>
                <div class="stat-item"><span class="stat-label">æ³•é˜²</span><span class="stat-value">${attr.magicDefense}</span></div>
                <div class="stat-item"><span class="stat-label">å‘½ä¸­</span><span class="stat-value">${attr.hit}%</span></div>
                <div class="stat-item"><span class="stat-label">é–ƒé¿</span><span class="stat-value">${attr.dodge}%</span></div>
                <div class="stat-item"><span class="stat-label">æš´æ“Šç‡</span><span class="stat-value">${attr.critRate}%</span></div>
                <div class="stat-item"><span class="stat-label">æš´å‚·</span><span class="stat-value">${attr.critDamage}%</span></div>
                <div class="stat-item"><span class="stat-label">æš´é˜²</span><span class="stat-value">${attr.critResist}%</span></div>
            `;
            container.innerHTML = html;
        }

        // ---------- æ¨¡æ…‹æ¡†æ§åˆ¶ ----------
        function showAuthModal(show) {
            const modal = document.getElementById('auth-modal');
            if (show) {
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        // ---------- å­˜æª”/è¼‰å…¥ (JSON) ----------
        function exportSave() {
            if (!currentUser || !playerData) { alert('è«‹å…ˆç™»å…¥'); return; }
            const saveObj = {
                user: currentUser.username,
                data: playerData,
                version: '1.0',
                exportTime: new Date().toISOString()
            };
            const json = JSON.stringify(saveObj, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dragon_age_${currentUser.username}_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('å­˜æª”å·²åŒ¯å‡º ğŸ“');
        }

        function importSave(file) {
            if (!currentUser) { alert('è«‹å…ˆç™»å…¥'); return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const parsed = JSON.parse(e.target.result);
                    if (parsed.data) {
                        playerData = parsed.data;
                        savePlayerData(currentUser.username, playerData);
                        updateUIForUser();
                        alert('å­˜æª”åŒ¯å…¥æˆåŠŸ âœ…');
                    } else {
                        alert('ç„¡æ•ˆçš„å­˜æª”æ ¼å¼');
                    }
                } catch (err) {
                    alert('è§£æå¤±æ•—ï¼š' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // ---------- åˆå§‹åŒ–äº‹ä»¶ç¶å®š ----------
        function initEventListeners() {
            document.getElementById('login-btn').addEventListener('click', () => {
                const u = document.getElementById('auth-username').value.trim();
                const p = document.getElementById('auth-password').value.trim();
                const res = login(u, p);
                if (res.success) {
                    showAuthModal(false);
                    updateUIForUser();
                } else {
                    document.getElementById('auth-message').textContent = res.msg;
                }
            });

            document.getElementById('register-btn').addEventListener('click', () => {
                const u = document.getElementById('auth-username').value.trim();
                const p = document.getElementById('auth-password').value.trim();
                const res = register(u, p);
                if (res.success) {
                    // è¨»å†Šå¾Œè‡ªå‹•ç™»å…¥
                    login(u, p);
                    showAuthModal(false);
                    updateUIForUser();
                } else {
                    document.getElementById('auth-message').textContent = res.msg;
                }
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                logout();
            });

            document.getElementById('save-game').addEventListener('click', () => {
                exportSave();
            });

            document.getElementById('load-game').addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json,application/json';
                input.onchange = (e) => {
                    if (e.target.files.length > 0) importSave(e.target.files[0]);
                };
                input.click();
            });

            // å¿«é€Ÿæˆ°é¬¥æ¸¬è©¦ (æš«æ™‚ç°¡å–®å¢åŠ ç¶“é©—)
            document.getElementById('quick-battle-btn').addEventListener('click', () => {
                if (!playerData) { alert('è«‹å…ˆç™»å…¥'); return; }
                playerData.exp += 20;
                if (playerData.exp >= playerData.expNext) {
                    playerData.level += 1;
                    playerData.exp -= playerData.expNext;
                    playerData.expNext = Math.floor(playerData.expNext * 1.5);
                    // å±¬æ€§æå‡ç¤ºç¯„
                    playerData.attributes.attack += 3;
                    playerData.attributes.defense += 2;
                }
                updateUIForUser();
                alert('æˆ°é¬¥å‹åˆ©ï¼ç²å¾—ç¶“é©—å€¼20');
            });
        }

        // ---------- Canvas ç¹ªè£½ (ç°¡å–®ä½”ä½) ----------
        function renderCanvas() {
            const canvas = document.getElementById('game-canvas');
            const ctx = canvas.getContext('2d');
            // èƒŒæ™¯
            ctx.fillStyle = '#1b232f';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            // ç•«ä¸€äº›ç°¡å–®å…ƒç´ 
            ctx.fillStyle = '#3e5a6f';
            ctx.font = 'bold 24px "å¾®è»Ÿæ­£é»‘é«”"';
            ctx.fillText('é¾æ—ç´€å…ƒ', 80, 120);
            ctx.fillStyle = '#aab9c9';
            ctx.font = '16px monospace';
            ctx.fillText('Canvas 2D ä½”ä½ç¹ªåœ–', 80, 200);
            if (currentUser) {
                ctx.fillStyle = '#b3a87e';
                ctx.fillText(`å†’éšªè€…: ${currentUser.username}`, 80, 280);
            } else {
                ctx.fillStyle = '#999';
                ctx.fillText('è«‹å…ˆç™»å…¥', 80, 280);
            }
        }

        // å‹•ç•«å¾ªç’° (ç°¡å–®)
        function gameLoop() {
            renderCanvas();
            requestAnimationFrame(gameLoop);
        }

        // ---------- å…¬é–‹ API ----------
        return {
            init: function() {
                initDefaultAdmin();
                initEventListeners();
                gameLoop();
                // è‡ªå‹•é¡¯ç¤ºç™»å…¥æ¨¡æ…‹
                showAuthModal(true);
            },
            // ä»¥ä¸‹ç‚ºå…¶ä»–æ¨¡å¡Šå¯èƒ½éœ€è¦çš„å­˜å– (å¾ŒçºŒæ“´å……)
            getPlayerData: () => playerData,
            getCurrentUser: () => currentUser,
            savePlayerData: () => { if(currentUser) savePlayerData(currentUser.username, playerData); }
        };
    })();

    // å•Ÿå‹•éŠæˆ²
    window.addEventListener('load', () => {
        Game.init();
    });
</script>
<!-- ç¬¬ä¸€æ¬¡è¼¸å‡ºçµæŸï¼šåŸºç¤æ¡†æ¶ + è¨»å†Šç™»å…¥ + å­˜æª”é››å½¢ + ç•«å¸ƒä½”ä½ -->
<!-- ========== è¿½åŠ åˆ° <style> æ¨™ç±¤å…§ ========== -->
<style>
    /* è£å‚™å“è³ªé¡è‰² */
    .q-gray { color: #9ca3af; }
    .q-green { color: #4ade80; }
    .q-blue { color: #60a5fa; }
    .q-purple { color: #c084fc; }
    .q-orange { color: #fbbf24; }

    .equipment-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-top: 8px;
    }
    .equip-slot {
        background: #1e2a36;
        border-radius: 12px;
        padding: 8px;
        border: 1px solid #4a5c70;
        font-size: 0.8rem;
        display: flex;
        flex-direction: column;
        cursor: pointer;
        transition: 0.2s;
    }
    .equip-slot:hover {
        background: #2c3d50;
        border-color: #a7c0db;
    }
    .slot-name {
        font-weight: 600;
        color: #bccde0;
    }
    .slot-item {
        color: #f0e6d2;
        word-break: break-word;
    }
    .slot-item small {
        opacity: 0.8;
        font-size: 0.7rem;
    }
    .inventory-panel {
        max-height: 200px;
        overflow-y: auto;
        background: #0f151d;
        border-radius: 12px;
        padding: 8px;
    }
    .inv-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 8px;
        border-bottom: 1px solid #2f3f4f;
        font-size: 0.85rem;
    }
    .inv-item:last-child { border-bottom: none; }
    .item-name { cursor: pointer; }
    .item-name:hover { text-decoration: underline; color: #ffd966; }
    .btn-small {
        background: #3a4b5e;
        border: none;
        color: white;
        border-radius: 20px;
        padding: 2px 12px;
        font-size: 0.75rem;
        cursor: pointer;
    }
    .btn-small:hover { background: #5f7794; }
    .exp-bar {
        background: #1f3140;
        height: 8px;
        border-radius: 20px;
        margin: 6px 0;
        overflow: hidden;
    }
    .exp-fill {
        height: 100%;
        background: linear-gradient(90deg, #b8860b, #ffd966);
        width: 0%;
    }
</style>

<!-- ========== è¿½åŠ åˆ° <div class="right-panel"> å…§éƒ¨ï¼ˆä¾‹å¦‚æ”¾åœ¨å¿«é€Ÿè£å‚™é¢æ¿ä¸‹æ–¹ï¼‰ ========== -->
<div class="panel-section" id="equipment-panel">
    <div class="panel-title">âš™ï¸ è£å‚™æ¬„</div>
    <div class="equipment-grid" id="equipment-grid">
        <!-- JSå‹•æ…‹ç”Ÿæˆ -->
    </div>
    <button id="one-click-equip" style="width:100%; margin-top:12px; background:#4f5b68; border:none; border-radius:30px; padding:8px; color:white;">âœ¨ ä¸€éµæœ€ä½³è£å‚™</button>
</div>

<div class="panel-section" id="inventory-panel">
    <div class="panel-title">ğŸ’ èƒŒåŒ… (é»åç¨±è£å‚™)</div>
    <div class="inventory-panel" id="inventory-list"></div>
</div>

<!-- ========== è¿½åŠ åˆ° <script> å€åŸŸ (æ“´å…… Game ç‰©ä»¶) ========== -->
<script>
    // ---------- æ“´å…… Game ç‰©ä»¶ï¼šå±¬æ€§ã€è£å‚™ã€æ‰è½ç³»çµ± ----------
    (function() {
        // å–å¾—åŸæœ‰ Game ç‰©ä»¶ (è‹¥å°šæœªå­˜åœ¨ï¼Œå‰‡å…ˆå»ºç«‹ç©ºç‰©ä»¶)
        const Game = window.Game || {};
        window.Game = Game;

        // ---------- è£å‚™é¡å‹å®šç¾© ----------
        const EQUIP_SLOTS = [
            { id: 'weapon', name: 'æ­¦å™¨', type: 'attack' },
            { id: 'wrist', name: 'è­·è…•', type: 'attack' },
            { id: 'ring', name: 'æˆ’æŒ‡', type: 'attack' },
            { id: 'amulet', name: 'è­·ç¬¦', type: 'attack' },
            { id: 'helmet', name: 'é ­ç›”', type: 'defense' },
            { id: 'armor', name: 'ç”²èƒ„', type: 'defense' },
            { id: 'gloves', name: 'æ‰‹å¥—', type: 'defense' },
            { id: 'boots', name: 'é‹å­', type: 'defense' },
            { id: 'shoulder', name: 'è­·è‚©', type: 'defense' },
            { id: 'belt', name: 'è…°å¸¶', type: 'defense' },
            { id: 'necklace', name: 'é …éˆ', type: 'hybrid' },
            { id: 'hiddenWeapon', name: 'æš—å™¨', type: 'hybrid' },
            { id: 'dragonMark', name: 'é¾ç´‹', type: 'hybrid' },
            { id: 'token', name: 'ä»¤ç‰Œ', type: 'hybrid' }
        ];

        // å“è³ªå°æ‡‰é¡è‰²é¡
        const QUALITY_CLASS = ['q-gray', 'q-green', 'q-blue', 'q-purple', 'q-orange'];

        // ---------- è£å‚™è³‡æ–™çµæ§‹ç¯„ä¾‹ (å…§å»ºä¸€äº›è£å‚™) ----------
        const EQUIPMENT_LIBRARY = [
            { id: 'iron_sword', name: 'éµåŠ', type: 'weapon', levelRequire: 1, quality: 0, star: 1, baseStats: { attack: 5 }, extraStats: [] },
            { id: 'bronze_helmet', name: 'é’éŠ…é ­ç›”', type: 'helmet', levelRequire: 1, quality: 0, star: 1, baseStats: { defense: 3 }, extraStats: [] },
            { id: 'leather_gloves', name: 'çš®æ‰‹å¥—', type: 'gloves', levelRequire: 1, quality: 0, star: 1, baseStats: { attack: 2 }, extraStats: [] },
            { id: 'spirit_ring', name: 'éˆåŠ›æˆ’æŒ‡', type: 'ring', levelRequire: 2, quality: 2, star: 2, baseStats: { magicDefense: 4, critRate: 2 }, extraStats: [ { stat: 'attack', value: 3 } ] },
        ];

        // ---------- è¼”åŠ©å‡½æ•¸ï¼šè¨ˆç®—è£å‚™ç¸½å±¬æ€§ (åŸºç¤+æ˜Ÿç´šå€ç‡+é¡å¤–å±¬æ€§) ----------
        function calcEquipmentStats(equip) {
            if (!equip) return {};
            const stats = {};
            // åŸºç¤å±¬æ€§ * (1 + 0.2*æ˜Ÿç´š) ç°¡å–®å…¬å¼
            const starFactor = 1 + 0.2 * (equip.star || 1);
            if (equip.baseStats) {
                for (let [key, val] of Object.entries(equip.baseStats)) {
                    stats[key] = Math.floor(val * starFactor);
                }
            }
            // é¡å¤–å±¬æ€§ç›´æ¥åŠ 
            if (equip.extraStats) {
                equip.extraStats.forEach(ext => {
                    stats[ext.stat] = (stats[ext.stat] || 0) + ext.value;
                });
            }
            return stats;
        }

        // ---------- é‡æ–°è¨ˆç®—ç©å®¶æœ€çµ‚å±¬æ€§ (åŸºç¤ + æ‰€æœ‰è£å‚™) ----------
        function recalcPlayerAttributes() {
            const player = Game.getPlayerData?.() || window.playerData; // å‘å¾Œç›¸å®¹
            if (!player) return;
            // åŸºç¤å±¬æ€§ (å¾ player.attributes è¤‡è£½ä¸€ä»½)
            const base = { ...player.baseAttributes }; // éœ€è¦å°‡åŸæœ¬çš„ attributes æ‹†æˆåŸºç¤èˆ‡æœ€çµ‚ï¼Œä½†ç‚ºäº†ç›¸å®¹ï¼Œæˆ‘å€‘ä¿ç•™åŸçµæ§‹
            // åŸæœ¬ player.attributes æ˜¯ç•¶å‰ç¸½å€¼ï¼Œç¾åœ¨æˆ‘å€‘æ”¹ç‚ºè¨ˆç®—å¾—ä¾†
            // ç‚ºç°¡åŒ–ï¼Œæˆ‘å€‘æŠŠ player.rawBase è¦–ç‚ºç­‰ç´šæˆé•·åŸºç¤ï¼Œå¦å­˜è£å‚™åŠ æˆ
            if (!player.rawBase) {
                // ç¬¬ä¸€æ¬¡é·ç§»ï¼šå°‡ç›®å‰ attributes è¦–ç‚ºåŸºç¤ï¼Œä¹‹å¾Œè£å‚™é¡å¤–åŠ æˆ
                player.rawBase = { ...player.attributes };
                player.equipStats = {};
            }
            // æ¸…ç©ºè£å‚™ç´¯åŠ 
            const finalStats = { ...player.rawBase };
            // éæ­·æ‰€æœ‰è£å‚™æ§½
            for (let slot of EQUIP_SLOTS) {
                const equip = player.equipment?.[slot.id];
                if (equip) {
                    const eqStats = calcEquipmentStats(equip);
                    for (let [stat, val] of Object.entries(eqStats)) {
                        finalStats[stat] = (finalStats[stat] || 0) + val;
                    }
                }
            }
            player.attributes = finalStats; // æ›´æ–°é¡¯ç¤ºç”¨å±¬æ€§
            player.equipStats = { ...finalStats }; // ä¿ç•™
        }

        // ---------- ç­‰ç´šç¶“é©—å…¬å¼ ----------
        function expNeededForLevel(level) {
            return Math.floor(100 * Math.pow(1.2, level - 1));
        }

        // å¢åŠ ç¶“é©—
        function addExp(amount) {
            const player = Game.getPlayerData?.();
            if (!player) return;
            player.exp += amount;
            while (player.exp >= player.expNext) {
                player.level++;
                player.exp -= player.expNext;
                player.expNext = expNeededForLevel(player.level);
                // å‡ç´šæå‡åŸºç¤å±¬æ€§
                player.rawBase.attack += 2;
                player.rawBase.defense += 1;
                player.rawBase.magicDefense += 1;
                player.rawBase.hit = Math.min(95, player.rawBase.hit + 1);
                // å…¶ä»–å¯è‡ªè¡Œå¢åŠ 
            }
            recalcPlayerAttributes();
            updateEquipmentUI();
        }

        // ---------- ä¸€éµæœ€ä½³è£å‚™ (ç°¡å–®ç‰ˆï¼šä¾é¡å‹å–æœ€é«˜æ”»æ“Š/é˜²ç¦¦) ----------
        function oneClickEquip() {
            const player = Game.getPlayerData?.();
            if (!player) return;
            const inventory = player.inventory || [];
            // æŒ‰æ§½ä½å˜—è©¦è£å‚™
            EQUIP_SLOTS.forEach(slot => {
                // æ‰¾å‡ºèƒŒåŒ…ä¸­è©²æ§½ä½ä¸”ç­‰ç´šç¬¦åˆçš„æœ€ä½³è£å‚™ (æ ¹æ“šé¡å‹è©•åˆ†)
                const candidates = inventory.filter(item => item.type === slot.id && item.levelRequire <= player.level);
                if (candidates.length === 0) return;
                // ç°¡å–®è©•åˆ†ï¼šæ”»æ“Šé¡å–æ”»æ“Šç¸½å’Œï¼Œé˜²ç¦¦é¡å–é˜²ç¦¦ç¸½å’Œï¼Œæ··åˆå–å…©è€…ä¹‹å’Œ
                candidates.forEach(item => {
                    const stats = calcEquipmentStats(item);
                    if (slot.type === 'attack') item.score = stats.attack || 0;
                    else if (slot.type === 'defense') item.score = (stats.defense || 0) + (stats.magicDefense || 0);
                    else item.score = (stats.attack || 0) + (stats.defense || 0) + (stats.magicDefense || 0);
                });
                candidates.sort((a,b) => b.score - a.score);
                const best = candidates[0];
                // å¸ä¸‹åŸæœ‰è£å‚™ (æ”¾å›èƒŒåŒ…)
                if (player.equipment[slot.id]) {
                    inventory.push(player.equipment[slot.id]);
                }
                // è£å‚™æœ€ä½³
                player.equipment[slot.id] = best;
                // å¾èƒŒåŒ…ç§»é™¤
                const idx = inventory.findIndex(i => i.id === best.id);
                if (idx !== -1) inventory.splice(idx, 1);
            });
            recalcPlayerAttributes();
            updateEquipmentUI();
        }

        // ---------- æ‰è½ç³»çµ±ï¼šéš¨æ©Ÿç”Ÿæˆä¸€ä»¶è£å‚™ (ç°¡æ˜“) ----------
        function generateRandomDrop(monsterLevel = 1) {
            const qualityRand = Math.random();
            let quality = 0;
            if (qualityRand < 0.5) quality = 0;      // 50% æ™®é€š
            else if (qualityRand < 0.75) quality = 1; // 25% å„ªç§€
            else if (qualityRand < 0.9) quality = 2;  // 15% ç¨€æœ‰
            else if (qualityRand < 0.97) quality = 3; // 7% å²è©©
            else quality = 4;                          // 3% å‚³èªª

            const star = Math.floor(Math.random() * 3) + 1; // 1~3æ˜Ÿ
            const slot = EQUIP_SLOTS[Math.floor(Math.random() * EQUIP_SLOTS.length)];
            // åŸºç¤å±¬æ€§ç”Ÿæˆ
            const baseStats = {};
            if (slot.type === 'attack') {
                baseStats.attack = Math.floor(Math.random() * 5 * (monsterLevel) + 3);
            } else if (slot.type === 'defense') {
                baseStats.defense = Math.floor(Math.random() * 4 * (monsterLevel) + 2);
                baseStats.magicDefense = Math.floor(Math.random() * 3 * (monsterLevel) + 1);
            } else {
                baseStats.attack = Math.floor(Math.random() * 3 * (monsterLevel) + 1);
                baseStats.defense = Math.floor(Math.random() * 2 * (monsterLevel) + 1);
                baseStats.magicDefense = Math.floor(Math.random() * 2 * (monsterLevel) + 1);
            }
            // éš¨æ©Ÿé¡å¤–å±¬æ€§ (å“è³ªè¶Šé«˜æ¢æ•¸è¶Šå¤š)
            const extraCount = Math.min(quality, 3); // 0~3æ¢
            const extraStats = [];
            const possibleStats = ['attack','defense','magicDefense','hit','dodge','critRate','critDamage','critResist'];
            for (let i=0; i<extraCount; i++) {
                const stat = possibleStats[Math.floor(Math.random() * possibleStats.length)];
                let val = Math.floor(Math.random() * 5) + 1;
                if (stat.includes('Rate') || stat === 'hit' || stat === 'dodge') val = Math.min(15, val);
                extraStats.push({ stat, value: val });
            }

            return {
                id: `drop_${Date.now()}_${Math.random()}`,
                name: `${['ç°¡æ˜“','å„ªè‰¯','ç¨€æœ‰','å²è©©','å‚³èªª'][quality]} ${slot.name}`,
                type: slot.id,
                levelRequire: Math.max(1, monsterLevel - 1 + Math.floor(Math.random()*3)),
                quality: quality,
                star: star,
                baseStats: baseStats,
                extraStats: extraStats
            };
        }

        // ---------- UI æ›´æ–°å‡½æ•¸ (è£å‚™æ¬„ã€èƒŒåŒ…) ----------
        function updateEquipmentUI() {
            const player = Game.getPlayerData?.();
            if (!player) return;

            // æ›´æ–°è£å‚™æ ¼å­
            const grid = document.getElementById('equipment-grid');
            if (grid) {
                grid.innerHTML = '';
                EQUIP_SLOTS.forEach(slot => {
                    const equip = player.equipment?.[slot.id];
                    const div = document.createElement('div');
                    div.className = 'equip-slot';
                    div.innerHTML = `
                        <span class="slot-name">${slot.name}</span>
                        <span class="slot-item ${equip ? QUALITY_CLASS[equip.quality] || '' : ''}">
                            ${equip ? equip.name : 'ç„¡'}
                            ${equip ? `<br><small>${equip.star}â˜…</small>` : ''}
                        </span>
                    `;
                    div.addEventListener('click', () => {
                        if (equip) {
                            // å¸ä¸‹è£å‚™
                            if (confirm(`å¸ä¸‹ ${equip.name}ï¼Ÿ`)) {
                                player.inventory.push(equip);
                                delete player.equipment[slot.id];
                                recalcPlayerAttributes();
                                updateEquipmentUI();
                            }
                        }
                    });
                    grid.appendChild(div);
                });
            }

            // æ›´æ–°èƒŒåŒ…
            const invDiv = document.getElementById('inventory-list');
            if (invDiv) {
                const inv = player.inventory || [];
                invDiv.innerHTML = '';
                inv.forEach((item, idx) => {
                    const row = document.createElement('div');
                    row.className = 'inv-item';
                    row.innerHTML = `
                        <span class="item-name ${QUALITY_CLASS[item.quality] || ''}" data-index="${idx}">${item.name} (${item.star}â˜…)</span>
                        <button class="btn-small" data-index="${idx}" data-action="sell">è³£å‡º</button>
                    `;
                    row.querySelector('.item-name').addEventListener('click', () => {
                        // è£å‚™ç‰©å“ (è‡ªå‹•åˆ¤æ–·æ§½ä½)
                        const slotId = item.type;
                        if (!slotId) return;
                        // æª¢æŸ¥ç­‰ç´š
                        if (item.levelRequire > player.level) {
                            alert('ç­‰ç´šä¸è¶³');
                            return;
                        }
                        // è‹¥è©²æ§½å·²æœ‰è£å‚™ï¼Œå…ˆæ”¾å›èƒŒåŒ…
                        if (player.equipment[slotId]) {
                            player.inventory.push(player.equipment[slotId]);
                        }
                        player.equipment[slotId] = item;
                        player.inventory.splice(idx, 1);
                        recalcPlayerAttributes();
                        updateEquipmentUI();
                    });
                    row.querySelector('.btn-small').addEventListener('click', (e) => {
                        e.stopPropagation();
                        // è³£å‡º (ç²å¾—é‡‘å¹£ï¼Œæ­¤è™•æš«æœªå¯¦ç¾é‡‘å¹£ç³»çµ±)
                        player.inventory.splice(idx, 1);
                        updateEquipmentUI();
                    });
                    invDiv.appendChild(row);
                });
            }

            // æ›´æ–°å±¬æ€§é¢æ¿
            if (typeof Game.updateStatsPanel === 'function') Game.updateStatsPanel();
            else {
                // ç°¡å–®æ›´æ–°
                const container = document.getElementById('stats-container');
                if (container && player.attributes) {
                    const a = player.attributes;
                    container.innerHTML = `
                        <div class="stat-item"><span>æ”»æ“Š</span><span>${a.attack || 0}</span></div>
                        <div class="stat-item"><span>ç‰©é˜²</span><span>${a.defense || 0}</span></div>
                        <div class="stat-item"><span>æ³•é˜²</span><span>${a.magicDefense || 0}</span></div>
                        <div class="stat-item"><span>å‘½ä¸­</span><span>${a.hit || 0}%</span></div>
                        <div class="stat-item"><span>é–ƒé¿</span><span>${a.dodge || 0}%</span></div>
                        <div class="stat-item"><span>æš´æ“Šç‡</span><span>${a.critRate || 0}%</span></div>
                        <div class="stat-item"><span>æš´å‚·</span><span>${a.critDamage || 0}%</span></div>
                        <div class="stat-item"><span>æš´é˜²</span><span>${a.critResist || 0}%</span></div>
                    `;
                }
            }

            // æ›´æ–°ç¶“é©—æ¢
            const expPercent = (player.exp / player.expNext) * 100;
            const expBar = document.querySelector('.exp-fill');
            if (expBar) expBar.style.width = expPercent + '%';
        }

        // ---------- æ“´å……å¿«é€Ÿæˆ°é¬¥ï¼ŒåŠ å…¥æ‰è½èˆ‡ç¶“é©— ----------
        const originalBattle = document.getElementById('quick-battle-btn')?.click; // é¿å…è¦†è“‹åŸæœ‰ç›£è½
        document.getElementById('quick-battle-btn')?.addEventListener('click', function() {
            const player = Game.getPlayerData?.();
            if (!player) { alert('è«‹å…ˆç™»å…¥'); return; }
            // ç²å¾—ç¶“é©—
            addExp(25);
            // æ‰è½æ©Ÿç‡ 70% æ‰è½ä¸€ä»¶è£å‚™
            if (Math.random() < 0.7) {
                const drop = generateRandomDrop(player.level);
                player.inventory = player.inventory || [];
                player.inventory.push(drop);
                alert(`æˆ°é¬¥å‹åˆ©ï¼ç²å¾—ç¶“é©—25ï¼Œä¸¦æ‰è½ ${drop.name}`);
            } else {
                alert('æˆ°é¬¥å‹åˆ©ï¼ç²å¾—ç¶“é©—25');
            }
            updateEquipmentUI();
        });

        // ---------- ç¶å®šä¸€éµè£å‚™æŒ‰éˆ• ----------
        document.getElementById('one-click-equip')?.addEventListener('click', () => {
            oneClickEquip();
        });

        // ---------- åˆå§‹åŒ–ï¼šå¦‚æœç©å®¶æ•¸æ“šç¼ºå°‘æ–°æ¬„ä½ï¼Œè£œé½Š ----------
        const origInit = Game.init;
        Game.init = function() {
            if (origInit) origInit.call(this);
            // é·ç§»èˆŠå­˜æª”ï¼Œå¢åŠ  rawBase èˆ‡ inventory
            const player = Game.getPlayerData?.();
            if (player && !player.rawBase) {
                player.rawBase = { ...player.attributes };
                player.inventory = player.inventory || [];
                player.equipment = player.equipment || {};
                // æ·»åŠ ä¸€äº›åˆå§‹è£å‚™
                if (player.inventory.length === 0) {
                    player.inventory.push({ ...EQUIPMENT_LIBRARY[0] }); // éµåŠ
                    player.inventory.push({ ...EQUIPMENT_LIBRARY[1] }); // é’éŠ…é ­ç›”
                }
                recalcPlayerAttributes();
            }
            // ç›£è½å­˜æª”å¾Œæ›´æ–°UI
            updateEquipmentUI();
            // æ“´å……åŸæœ¬çš„å­˜æª”/è¼‰å…¥äº‹ä»¶
        };

        // ç¢ºä¿ updateEquipmentUI å¯åœ¨å¤–éƒ¨å­˜å–
        Game.updateEquipmentUI = updateEquipmentUI;
    })();
</script>
<!-- ========== è¿½åŠ åˆ° <style> æ¨™ç±¤å…§ ========== -->
<style>
    /* å•†åŸ/åˆæˆæ¨¡æ…‹æ¡†å°ˆç”¨æ¨£å¼ */
    .modal-lg {
        width: 600px;
        max-width: 90vw;
        max-height: 80vh;
        overflow-y: auto;
    }
    .item-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
        margin: 20px 0;
    }
    .shop-item {
        background: #1f2a36;
        border-radius: 16px;
        padding: 12px;
        border: 1px solid #4d6278;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    .shop-item .name {
        font-weight: bold;
        color: #e9d7a3;
    }
    .shop-item .price {
        color: #ffd966;
        margin: 8px 0;
    }
    .shop-item button {
        background: #7a5f3a;
        border: none;
        border-radius: 30px;
        padding: 6px 16px;
        color: white;
        cursor: pointer;
        width: 100%;
    }
    .shop-item button:hover { background: #9b7b50; }
    .shop-item button:disabled {
        background: #4f5b68;
        cursor: not-allowed;
    }

    .synthesis-panel {
        background: #1e2a36;
        border-radius: 20px;
        padding: 20px;
        margin-top: 16px;
    }
    .slot-row {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: center;
        margin: 15px 0;
        flex-wrap: wrap;
    }
    .material-slot {
        width: 70px;
        height: 70px;
        background: #0f1a24;
        border-radius: 12px;
        border: 2px solid #4f6580;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        color: #bbb;
        cursor: pointer;
        transition: 0.2s;
    }
    .material-slot.selected {
        border-color: #ffd966;
        background: #1e3142;
    }
    .arrow {
        font-size: 2rem;
        color: #8a9bb0;
    }
    .result-slot {
        width: 90px;
        height: 90px;
        background: #2c3d50;
        border-radius: 16px;
        border: 2px solid #b5945a;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    .gold-display {
        background: #2f3e4f;
        border-radius: 40px;
        padding: 4px 18px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: 1px solid #a38b5f;
        color: #ffd966;
        font-weight: 600;
    }
</style>

<!-- ========== è¿½åŠ åˆ° <div class="status-bar"> å…§éƒ¨ï¼ˆæ”¾åœ¨å³å´æŒ‰éˆ•ç¾¤çµ„ï¼‰ ========== -->
<div class="game-actions" style="margin-left:auto; display:flex; gap:8px;">
    <span class="gold-display" id="gold-amount">ğŸ’° 0</span>
    <button id="open-shop-btn">ğŸ›’ å•†åŸ</button>
    <button id="open-synthesis-btn">âš—ï¸ åˆæˆ</button>
</div>

<!-- ========== å•†åŸæ¨¡æ…‹æ¡† (éš±è—) ========== -->
<div id="shop-modal" class="modal hidden">
    <div class="modal-card modal-lg">
        <h2>ğŸ›ï¸ å•†åŸ</h2>
        <div id="shop-items" class="item-grid">
            <!-- å‹•æ…‹ç”Ÿæˆ -->
        </div>
        <div class="modal-actions">
            <button class="modal-btn secondary" id="close-shop">é—œé–‰</button>
        </div>
    </div>
</div>

<!-- ========== åˆæˆæ¨¡æ…‹æ¡† (éš±è—) ========== -->
<div id="synthesis-modal" class="modal hidden">
    <div class="modal-card modal-lg">
        <h2>ğŸ”® å¯¶çŸ³åˆæˆ</h2>
        <div class="synthesis-panel">
            <div class="slot-row">
                <div class="material-slot" id="syn-material-1">ææ–™1</div>
                <div class="material-slot" id="syn-material-2">ææ–™2</div>
                <div class="material-slot" id="syn-material-3">ææ–™3</div>
                <span class="arrow">â†’</span>
                <div class="result-slot" id="syn-result">çµæœ</div>
            </div>
            <div style="display:flex; gap:20px; justify-content:center; margin:20px 0;">
                <button id="syn-do" class="modal-btn primary" disabled>åˆæˆ</button>
                <button id="syn-reset" class="modal-btn secondary">é‡ç½®</button>
            </div>
            <p id="syn-message" style="color:#c0b09a; text-align:center;"></p>
        </div>
        <div class="modal-actions">
            <button class="modal-btn secondary" id="close-synthesis">é—œé–‰</button>
        </div>
    </div>
</div>

<!-- ========== è¿½åŠ åˆ° <script> å€åŸŸ ========== -->
<script>
    (function() {
        const Game = window.Game;
        if (!Game) return;

        // ---------- åˆå§‹åŒ–è²¨å¹£èˆ‡å•†å“æ•¸æ“š ----------
        function ensurePlayerData() {
            const player = Game.getPlayerData?.();
            if (player) {
                if (player.gold === undefined) player.gold = 100; // åˆå§‹é‡‘å¹£
                if (!player.gemInventory) player.gemInventory = []; // å¯¶çŸ³èƒŒåŒ…
            }
            return player;
        }

        // ---------- å•†å“åº« ----------
        const SHOP_ITEMS = [
            { id: 'blueprint_1', name: 'æ­¦å™¨æ‰“é€ è—åœ–', type: 'blueprint', price: 150, itemType: 'blueprint' },
            { id: 'material_iron', name: 'éµç¤¦', type: 'material', price: 30, itemType: 'material' },
            { id: 'stone_sharp', name: 'ç£¨åˆ€çŸ³', type: 'consumable', price: 45, itemType: 'sharpening_stone' },
            { id: 'gem_lv1', name: 'ä¸€ç´šæ”»æ“Šå¯¶çŸ³', type: 'gem', level: 1, stat: 'attack', value: 5, price: 80, itemType: 'gem' },
            { id: 'gem_lv1_def', name: 'ä¸€ç´šé˜²ç¦¦å¯¶çŸ³', type: 'gem', level: 1, stat: 'defense', value: 4, price: 70, itemType: 'gem' },
            { id: 'synthesis_scroll', name: 'åˆæˆç¬¦', type: 'consumable', price: 100, itemType: 'scroll' },
        ];

        // ---------- å¯¶çŸ³åˆæˆé…æ–¹ï¼š3å€‹åŒç´šåŒå±¬æ€§å¯¶çŸ³ -> 1å€‹é«˜ä¸€ç´šå¯¶çŸ³ ----------
        function getNextGemLevel(gemItem) {
            if (!gemItem || gemItem.type !== 'gem') return null;
            return {
                ...gemItem,
                level: gemItem.level + 1,
                value: Math.floor(gemItem.value * 2.2), // æˆé•·å…¬å¼
                name: gemItem.name.replace(/[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹]/, l => ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'][gemItem.level] || '?'),
                price: gemItem.price * 3 + 50,
            };
        }

        // ---------- æ›´æ–°é‡‘å¹£é¡¯ç¤º ----------
        function updateGoldUI() {
            const player = Game.getPlayerData?.();
            const goldSpan = document.getElementById('gold-amount');
            if (goldSpan && player) {
                goldSpan.textContent = `ğŸ’° ${player.gold || 0}`;
            }
        }

        // ---------- æ¸²æŸ“å•†åŸ ----------
        function renderShop() {
            const container = document.getElementById('shop-items');
            if (!container) return;
            const player = Game.getPlayerData?.();
            if (!player) return;
            container.innerHTML = '';
            SHOP_ITEMS.forEach(item => {
                const div = document.createElement('div');
                div.className = 'shop-item';
                div.innerHTML = `
                    <div class="name">${item.name}</div>
                    <div class="price">${item.price}ğŸ’°</div>
                    <button data-id="${item.id}">è³¼è²·</button>
                `;
                const btn = div.querySelector('button');
                btn.disabled = (player.gold || 0) < item.price;
                btn.addEventListener('click', () => buyItem(item));
                container.appendChild(div);
            });
        }

        // è³¼è²·ç‰©å“
        function buyItem(item) {
            const player = Game.getPlayerData?.();
            if (!player) return;
            if (player.gold < item.price) {
                alert('é‡‘å¹£ä¸è¶³');
                return;
            }
            player.gold -= item.price;
            // åŠ å…¥èƒŒåŒ…
            const newItem = { 
                ...item, 
                instanceId: `${item.id}_${Date.now()}_${Math.random()}`,
                // å¦‚æœæ˜¯å¯¶çŸ³ï¼Œä¿ç•™å±¬æ€§
            };
            if (item.type === 'gem') {
                player.gemInventory = player.gemInventory || [];
                player.gemInventory.push(newItem);
            } else {
                player.inventory = player.inventory || [];
                player.inventory.push(newItem);
            }
            updateGoldUI();
            renderShop(); // åˆ·æ–°æŒ‰éˆ•ç‹€æ…‹
            Game.updateEquipmentUI?.(); // æ›´æ–°èƒŒåŒ…é¡¯ç¤º
            alert(`è³¼è²·æˆåŠŸï¼ç²å¾— ${item.name}`);
        }

        // ---------- åˆæˆç³»çµ± ----------
        let selectedMaterials = []; // å­˜æ”¾é¸ä¸­çš„å¯¶çŸ³å¯¦ä¾‹ID

        function renderSynthesis() {
            const player = Game.getPlayerData?.();
            if (!player) return;
            const gems = player.gemInventory || [];
            // æ›´æ–°ææ–™æ ¼å­é¡¯ç¤º
            for (let i = 0; i < 3; i++) {
                const slot = document.getElementById(`syn-material-${i+1}`);
                if (!slot) continue;
                const gem = selectedMaterials[i] ? gems.find(g => g.instanceId === selectedMaterials[i]) : null;
                slot.innerHTML = gem ? `${gem.name}<br>Lv.${gem.level}` : `ææ–™${i+1}`;
                slot.classList.toggle('selected', !!gem);
                // é»æ“Šé¸æ“‡ææ–™ (ç°¡å–®å¯¦ä½œï¼šé»æ“Šç©ºç™½æ ¼å¾èƒŒåŒ…é¸å–)
                slot.onclick = () => {
                    if (selectedMaterials[i]) {
                        // å¦‚æœå·²æœ‰ï¼Œå‰‡å–æ¶ˆé¸æ“‡
                        selectedMaterials[i] = null;
                    } else {
                        // å½ˆå‡ºé¸æ“‡è¦–çª— (ç‚ºç°¡åŒ–ï¼Œè‡ªå‹•é¸å–ç¬¬ä¸€å€‹ç¬¦åˆæ¢ä»¶çš„)
                        const available = gems.filter(g => !selectedMaterials.includes(g.instanceId) && g.type === 'gem');
                        if (available.length > 0) {
                            selectedMaterials[i] = available[0].instanceId;
                        } else {
                            alert('æ²’æœ‰å¯ç”¨çš„å¯¶çŸ³');
                        }
                    }
                    renderSynthesis();
                };
            }

            // è¨ˆç®—æ˜¯å¦å¯ä»¥åˆæˆ
            const gems = player.gemInventory || [];
            const selectedGems = selectedMaterials.map(id => gems.find(g => g.instanceId === id)).filter(Boolean);
            const canSynthesize = selectedGems.length === 3 && 
                selectedGems.every(g => g && g.type === 'gem') &&
                selectedGems.every(g => g.level === selectedGems[0].level) &&
                selectedGems.every(g => g.stat === selectedGems[0].stat);

            const resultGem = canSynthesize ? getNextGemLevel(selectedGems[0]) : null;
            const resultSlot = document.getElementById('syn-result');
            if (resultSlot) {
                resultSlot.innerHTML = resultGem ? `${resultGem.name}<br>Lv.${resultGem.level}` : '?';
            }

            const synBtn = document.getElementById('syn-do');
            if (synBtn) {
                synBtn.disabled = !canSynthesize;
                synBtn.onclick = () => {
                    if (!canSynthesize) return;
                    // æ‰£é™¤ä¸‰å€‹ææ–™
                    selectedMaterials.forEach(id => {
                        const idx = player.gemInventory.findIndex(g => g.instanceId === id);
                        if (idx !== -1) player.gemInventory.splice(idx, 1);
                    });
                    // æ·»åŠ åˆæˆå¾Œçš„å¯¶çŸ³
                    const newGem = { ...resultGem, instanceId: `gem_${Date.now()}_${Math.random()}` };
                    player.gemInventory.push(newGem);
                    selectedMaterials = [];
                    renderSynthesis();
                    Game.updateEquipmentUI?.(); // èƒŒåŒ…æ›´æ–°
                    updateGoldUI(); // å¯èƒ½é‡‘å¹£ä¸è®Šï¼Œä½†ç‚ºäº†çµ±ä¸€
                    alert(`åˆæˆæˆåŠŸï¼ç²å¾— ${newGem.name}`);
                };
            }

            document.getElementById('syn-reset')?.addEventListener('click', () => {
                selectedMaterials = [];
                renderSynthesis();
            });

            document.getElementById('syn-message').innerText = canSynthesize ? 'å¯ä»¥åˆæˆ' : 'éœ€è¦3å€‹åŒç´šåŒå±¬æ€§å¯¶çŸ³';
        }

        // ---------- é–‹å•Ÿ/é—œé–‰æ¨¡æ…‹æ¡† ----------
        function showModal(modalId, show) {
            const modal = document.getElementById(modalId);
            if (modal) {
                if (show) {
                    modal.classList.remove('hidden');
                    if (modalId === 'shop-modal') renderShop();
                    if (modalId === 'synthesis-modal') renderSynthesis();
                } else {
                    modal.classList.add('hidden');
                }
            }
        }

        // ---------- åˆå§‹åŒ–äº‹ä»¶ç›£è½ ----------
        function bindUI() {
            document.getElementById('open-shop-btn')?.addEventListener('click', () => showModal('shop-modal', true));
            document.getElementById('close-shop')?.addEventListener('click', () => showModal('shop-modal', false));
            document.getElementById('open-synthesis-btn')?.addEventListener('click', () => showModal('synthesis-modal', true));
            document.getElementById('close-synthesis')?.addEventListener('click', () => showModal('synthesis-modal', false));
        }

        // ---------- æ“´å……åŸæœ‰åˆå§‹åŒ– ----------
        const origInit = Game.init;
        Game.init = function() {
            if (origInit) origInit.call(this);
            ensurePlayerData();
            bindUI();
            updateGoldUI();
            // æ¯æ¬¡ç™»å…¥æˆ–åˆ‡æ›ç”¨æˆ¶æ™‚æ›´æ–°é‡‘å¹£ (å¯é€éç›£è½)
        };

        // åœ¨åŸæœ‰ updateEquipmentUI å¾Œæ›´æ–°é‡‘å¹£
        const origUpdateUI = Game.updateEquipmentUI;
        Game.updateEquipmentUI = function() {
            if (origUpdateUI) origUpdateUI();
            updateGoldUI();
        };

        // ç¢ºä¿æ¯æ¬¡å–å¾—ç©å®¶æ•¸æ“šæ™‚éƒ½ç¢ºä¿æœ‰ gold
        const origGetPlayer = Game.getPlayerData;
        Game.getPlayerData = function() {
            const player = origGetPlayer ? origGetPlayer() : window.playerData;
            if (player && player.gold === undefined) player.gold = 100;
            return player;
        };

        Game.updateEquipmentUI = function() {
            const player = Game.getPlayerData?.();
            if (!player) return;

            // æ›´æ–°è£å‚™æ ¼å­
            const grid = document.getElementById('equipment-grid');
            if (grid) {
                grid.innerHTML = '';
                EQUIP_SLOTS.forEach(slot => {
                    const equip = player.equipment?.[slot.id];
                    const div = document.createElement('div');
                    div.className = 'equip-slot';
                    div.innerHTML = `
                        <span class="slot-name">${slot.name}</span>
                        <span class="slot-item ${equip ? QUALITY_CLASS[equip.quality] || '' : ''}">
                            ${equip ? equip.name : 'ç„¡'}
                            ${equip ? `<br><small>${equip.star}â˜…</small>` : ''}
                        </span>
                    `;
                    div.addEventListener('click', () => {
                        if (equip) {
                            if (confirm(`å¸ä¸‹ ${equip.name}ï¼Ÿ`)) {
                                player.inventory.push(equip);
                                delete player.equipment[slot.id];
                                recalcPlayerAttributes();
                                Game.updateEquipmentUI();
                            }
                        }
                    });
                    grid.appendChild(div);
                });
            }

            // æ›´æ–°èƒŒåŒ…
            const invDiv = document.getElementById('inventory-list');
            if (invDiv) {
                const inv = player.inventory || [];
                invDiv.innerHTML = '';
                inv.forEach((item, idx) => {
                    const row = document.createElement('div');
                    row.className = 'inv-item';
                    row.innerHTML = `
                        <span class="item-name ${QUALITY_CLASS[item.quality] || ''}" data-index="${idx}">${item.name} (${item.star || 1}â˜…)</span>
                        <button class="btn-small" data-index="${idx}" data-action="sell">è³£å‡º</button>
                    `;
                    row.querySelector('.item-name').addEventListener('click', () => {
                        const slotId = item.type;
                        if (!slotId) return;
                        if (item.levelRequire > player.level) {
                            alert('ç­‰ç´šä¸è¶³');
                            return;
                        }
                        if (player.equipment[slotId]) {
                            player.inventory.push(player.equipment[slotId]);
                        }
                        player.equipment[slotId] = item;
                        player.inventory.splice(idx, 1);
                        recalcPlayerAttributes();
                        Game.updateEquipmentUI();
                    });
                    row.querySelector('.btn-small').addEventListener('click', (e) => {
                        e.stopPropagation();
                        // è³£å‡ºç²å¾—é‡‘å¹£ (åƒ¹æ ¼ç‚º item.price æˆ–åŸºç¤å€¼)
                        const price = item.price || 10; // è‹¥ç„¡åƒ¹æ ¼é è¨­10
                        player.gold = (player.gold || 0) + price;
                        player.inventory.splice(idx, 1);
                        updateGoldUI();
                        Game.updateEquipmentUI(); // åˆ·æ–°èƒŒåŒ…
                    });
                    invDiv.appendChild(row);
                });
            }

            // æ›´æ–°å±¬æ€§é¢æ¿
            const container = document.getElementById('stats-container');
            if (container && player.attributes) {
                const a = player.attributes;
                container.innerHTML = `
                    <div class="stat-item"><span>æ”»æ“Š</span><span>${a.attack || 0}</span></div>
                    <div class="stat-item"><span>ç‰©é˜²</span><span>${a.defense || 0}</span></div>
                    <div class="stat-item"><span>æ³•é˜²</span><span>${a.magicDefense || 0}</span></div>
                    <div class="stat-item"><span>å‘½ä¸­</span><span>${a.hit || 0}%</span></div>
                    <div class="stat-item"><span>é–ƒé¿</span><span>${a.dodge || 0}%</span></div>
                    <div class="stat-item"><span>æš´æ“Šç‡</span><span>${a.critRate || 0}%</span></div>
                    <div class="stat-item"><span>æš´å‚·</span><span>${a.critDamage || 0}%</span></div>
                    <div class="stat-item"><span>æš´é˜²</span><span>${a.critResist || 0}%</span></div>
                `;
            }

            updateGoldUI(); // æ›´æ–°é‡‘å¹£é¡¯ç¤º
        };

        // é‡æ–°ç¶å®šä¸€éµè£å‚™ç­‰ï¼ˆåŸæœ‰ç¶å®šä»æœ‰æ•ˆï¼Œä½†éœ€ç¢ºä¿å¼•ç”¨æ–°å‡½æ•¸ï¼‰
        // ç”±æ–¼ç¬¬äºŒæ¬¡è¼¸å‡ºä¸­ oneClickEquip ä¾è³´ recalcPlayerAttributesï¼Œæˆ‘å€‘éœ€ç¢ºä¿è©²å‡½æ•¸å­˜åœ¨ï¼ˆå·²åœ¨ç¬¬äºŒæ¬¡è¼¸å‡ºå®šç¾©ï¼‰ã€‚
        // ä¸€åˆ‡å°±ç·’ã€‚
    })();
</script>
<!-- ========== è¿½åŠ åˆ° <style> æ¨™ç±¤å…§ ========== -->
<style>
    /* å¼·åŒ–ã€é›é€ ã€é‘²åµŒå…±ç”¨æ¨£å¼ */
    .action-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        border-bottom: 2px solid #3f5568;
        padding-bottom: 8px;
    }
    .tab-btn {
        background: none;
        border: none;
        color: #aabcde;
        font-size: 1.1rem;
        padding: 6px 18px;
        border-radius: 30px;
        cursor: pointer;
        transition: 0.2s;
    }
    .tab-btn.active {
        background: #5f7794;
        color: #fff;
    }
    .slot-grid {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
        margin: 20px 0;
    }
    .icon-slot {
        width: 70px;
        height: 70px;
        background: #1e2e3e;
        border-radius: 16px;
        border: 2px solid #4d6a88;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        color: #c0d0e0;
        position: relative;
    }
    .icon-slot.selected {
        border-color: #ffaa33;
        background: #2a4055;
    }
    .cost-display {
        background: #2a3645;
        padding: 8px 16px;
        border-radius: 30px;
        margin: 15px 0;
    }
    .gem-sockets {
        display: flex;
        gap: 8px;
        margin: 10px 0;
        flex-wrap: wrap;
    }
    .socket {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: #253746;
        border: 2px dashed #7f8fa0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        cursor: pointer;
    }
    .socket.filled {
        border: 2px solid #ffaa33;
        background: #3f5a77;
    }
    .market-item {
        background: #202e3c;
        border-radius: 16px;
        padding: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .market-seller {
        font-size: 0.8rem;
        color: #9aaec5;
    }
</style>

<!-- ========== è¿½åŠ æ¨¡æ…‹æ¡†ï¼šå¼·åŒ–/é›é€ /é‘²åµŒ (å¤šåŠŸèƒ½) ========== -->
<div id="forge-modal" class="modal hidden">
    <div class="modal-card modal-lg">
        <h2>âš’ï¸ éµåŒ é‹ª</h2>
        <div class="action-tabs">
            <button class="tab-btn active" data-forge-tab="enhance">å¼·åŒ–</button>
            <button class="tab-btn" data-forge-tab="craft">é›é€ </button>
            <button class="tab-btn" data-forge-tab="socket">é‘²åµŒ</button>
        </div>
        <div id="forge-content">
            <!-- å‹•æ…‹è¼‰å…¥å…§å®¹ -->
        </div>
        <div class="modal-actions">
            <button class="modal-btn secondary" id="close-forge">é—œé–‰</button>
        </div>
    </div>
</div>

<!-- ========== è¿½åŠ æ¨¡æ…‹æ¡†ï¼šé»‘å¸‚ ========== -->
<div id="market-modal" class="modal hidden">
    <div class="modal-card modal-lg">
        <h2>ğŸª é»‘å¸‚</h2>
        <div style="display:flex; gap:8px; margin-bottom:16px;">
            <button id="market-sell-tab" class="tab-btn active">å‡ºå”®ç‰©å“</button>
            <button id="market-buy-tab" class="tab-btn">è³¼è²·ç‰©å“</button>
        </div>
        <div id="market-content">
            <!-- å‹•æ…‹å…§å®¹ -->
        </div>
        <div class="modal-actions">
            <button class="modal-btn secondary" id="close-market">é—œé–‰</button>
        </div>
    </div>
</div>

<!-- ========== è¿½åŠ åˆ°ç‹€æ…‹æ¬„æŒ‰éˆ•ç¾¤çµ„ (å·²æœ‰å•†åŸã€åˆæˆï¼Œå†è¿½åŠ å…©å€‹) ========== -->
<!-- è«‹åœ¨ç¬¬ä¸‰æ¬¡è¼¸å‡ºè¿½åŠ çš„æŒ‰éˆ•ç¾¤çµ„å…§å†å¢åŠ å…©å€‹æŒ‰éˆ• -->
<div style="display:flex; gap:8px;">
    <button id="open-forge-btn">ğŸ”¨ éµåŒ é‹ª</button>
    <button id="open-market-btn">ğŸ›ï¸ é»‘å¸‚</button>
</div>

<!-- ========== è¿½åŠ åˆ° <script> å€åŸŸ ========== -->
<script>
    (function() {
        const Game = window.Game;
        if (!Game) return;

        // ---------- ç¢ºä¿ç©å®¶æ•¸æ“šä¸­æœ‰å¼·åŒ–çŸ³ã€é‘²åµŒç¬¦ç­‰ ----------
        function ensureForgeMaterials() {
            const player = Game.getPlayerData?.();
            if (player) {
                if (player.enhanceStone === undefined) player.enhanceStone = 5;   // åˆå§‹å¼·åŒ–çŸ³
                if (player.inlayScroll === undefined) player.inlayScroll = 2;     // é‘²åµŒç¬¦
                if (player.removeScroll === undefined) player.removeScroll = 1;    // æ‘˜é™¤ç¬¦
                if (!player.gemSockets) player.gemSockets = {};                    // è¨˜éŒ„è£å‚™å¯¶çŸ³æ§½
            }
        }

        // ---------- å¼·åŒ–ç³»çµ± ----------
        function enhanceEquipment(equip) {
            if (!equip) return { success: false, msg: 'è«‹é¸æ“‡è£å‚™' };
            const player = Game.getPlayerData();
            const costGold = 50 * (equip.star || 1);
            const costStone = 1 + (equip.star || 0);
            if (player.gold < costGold) return { success: false, msg: 'é‡‘å¹£ä¸è¶³' };
            if (player.enhanceStone < costStone) return { success: false, msg: 'å¼·åŒ–çŸ³ä¸è¶³' };
            // å¼·åŒ–æˆåŠŸç‡ï¼šåŸºç¤80%ï¼Œæ¯æ˜Ÿéæ¸›
            const rate = Math.max(0.2, 0.8 - (equip.star - 1) * 0.1);
            if (Math.random() < rate) {
                equip.star = (equip.star || 1) + 1;
                player.gold -= costGold;
                player.enhanceStone -= costStone;
                return { success: true, msg: `å¼·åŒ–æˆåŠŸï¼è£å‚™å‡è‡³ ${equip.star} æ˜Ÿ` };
            } else {
                // å¤±æ•—å¯èƒ½é™æ˜Ÿæˆ–æå£ï¼Œç°¡åŒ–ç‚ºä¸è®Š
                player.gold -= costGold;
                player.enhanceStone -= costStone;
                return { success: false, msg: 'å¼·åŒ–å¤±æ•—ï¼Œææ–™æ¶ˆè€—' };
            }
        }

        // ---------- é›é€ ç³»çµ± (æ¶ˆè€—è—åœ–+ææ–™) ----------
        const RECIPES = [
            { id: 'weapon_lv5', name: 'é’éŠ…åŠ', type: 'weapon', levelRequire: 5, blueprint: 'blueprint_1', materials: { iron: 3 }, baseStats: { attack: 20 } },
            { id: 'armor_lv5', name: 'é±—ç”²', type: 'armor', levelRequire: 5, blueprint: 'blueprint_2', materials: { iron: 5, leather: 2 }, baseStats: { defense: 15 } },
        ];

        function craftItem(recipeId) {
            const player = Game.getPlayerData();
            const recipe = RECIPES.find(r => r.id === recipeId);
            if (!recipe) return { success: false, msg: 'é…æ–¹ä¸å­˜åœ¨' };
            if (player.level < recipe.levelRequire) return { success: false, msg: 'ç­‰ç´šä¸è¶³' };
            // æª¢æŸ¥è—åœ–
            const hasBlueprint = player.inventory?.some(i => i.id === recipe.blueprint);
            if (!hasBlueprint) return { success: false, msg: 'ç¼ºå°‘è—åœ–' };
            // æª¢æŸ¥ææ–™
            for (let [mat, qty] of Object.entries(recipe.materials)) {
                const count = player.inventory?.filter(i => i.id === mat || i.type === mat).length || 0;
                if (count < qty) return { success: false, msg: `ææ–™ ${mat} ä¸è¶³` };
            }
            // æ‰£é™¤ææ–™
            recipe.materials.forEach((qty, mat) => {
                for (let i = 0; i < qty; i++) {
                    const idx = player.inventory.findIndex(it => it.id === mat || it.type === mat);
                    if (idx !== -1) player.inventory.splice(idx, 1);
                }
            });
            // æ‰£é™¤è—åœ–
            const blueprintIdx = player.inventory.findIndex(i => i.id === recipe.blueprint);
            if (blueprintIdx !== -1) player.inventory.splice(blueprintIdx, 1);
            // ç”Ÿæˆæ–°è£å‚™
            const newEquip = {
                ...recipe,
                instanceId: `craft_${Date.now()}_${Math.random()}`,
                star: 1,
                quality: 2, // é è¨­è—è‰²
                extraStats: []
            };
            player.inventory.push(newEquip);
            return { success: true, msg: `é›é€ æˆåŠŸï¼ç²å¾— ${recipe.name}` };
        }

        // ---------- å¯¶çŸ³é‘²åµŒ/æ‘˜é™¤ ----------
        // è£å‚™æ·»åŠ å¯¶çŸ³æ§½ï¼ˆç°¡åŒ–ï¼šæ¯å€‹è£å‚™é è¨­3å€‹æ§½ï¼‰
        function getEquipmentSockets(equip) {
            return 3; // å›ºå®š3æ§½
        }

        function inlayGem(equip, gem, socketIndex) {
            const player = Game.getPlayerData();
            if (!equip || !gem) return { success: false, msg: 'è«‹é¸æ“‡è£å‚™å’Œå¯¶çŸ³' };
            if (!player.inlayScroll || player.inlayScroll < 1) return { success: false, msg: 'éœ€è¦é‘²åµŒç¬¦' };
            // æª¢æŸ¥æ§½ä½
            if (!player.gemSockets[equip.instanceId]) {
                player.gemSockets[equip.instanceId] = [];
            }
            if (player.gemSockets[equip.instanceId].length >= getEquipmentSockets(equip)) {
                return { success: false, msg: 'å¯¶çŸ³æ§½å·²æ»¿' };
            }
            if (player.gemSockets[equip.instanceId][socketIndex]) {
                return { success: false, msg: 'è©²æ§½å·²æœ‰å¯¶çŸ³' };
            }
            // å¾èƒŒåŒ…ç§»é™¤å¯¶çŸ³
            const gemIdx = player.gemInventory?.findIndex(g => g.instanceId === gem.instanceId);
            if (gemIdx === -1 || gemIdx === undefined) return { success: false, msg: 'å¯¶çŸ³ä¸å­˜åœ¨' };
            player.gemInventory.splice(gemIdx, 1);
            // é‘²åµŒ
            player.gemSockets[equip.instanceId][socketIndex] = gem;
            player.inlayScroll--;
            // é‡æ–°è¨ˆç®—å±¬æ€§
            recalcPlayerAttributes(); // éœ€å¼•å…¥ recalc å‡½æ•¸
            return { success: true, msg: 'é‘²åµŒæˆåŠŸ' };
        }

        function removeGem(equip, socketIndex) {
            const player = Game.getPlayerData();
            if (!equip) return { success: false, msg: 'è«‹é¸æ“‡è£å‚™' };
            if (!player.removeScroll || player.removeScroll < 1) return { success: false, msg: 'éœ€è¦æ‘˜é™¤ç¬¦' };
            const sockets = player.gemSockets[equip.instanceId];
            if (!sockets || !sockets[socketIndex]) return { success: false, msg: 'è©²æ§½ç„¡å¯¶çŸ³' };
            // å–å‡ºå¯¶çŸ³æ”¾å›èƒŒåŒ…
            const gem = sockets[socketIndex];
            player.gemInventory.push(gem);
            sockets[socketIndex] = null;
            player.removeScroll--;
            recalcPlayerAttributes();
            return { success: true, msg: 'æ‘˜é™¤æˆåŠŸ' };
        }

        // ---------- é»‘å¸‚äº¤æ˜“ç³»çµ± ----------
        const MARKET_KEY = 'dragon_age_market';

        function getMarketItems() {
            const data = localStorage.getItem(MARKET_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveMarketItems(items) {
            localStorage.setItem(MARKET_KEY, JSON.stringify(items));
        }

        // ä¸Šæ¶ç‰©å“
        function listItem(item, price) {
            const player = Game.getPlayerData();
            if (!player) return { success: false, msg: 'è«‹å…ˆç™»å…¥' };
            // å¾èƒŒåŒ…ç§»é™¤
            const idx = player.inventory.findIndex(i => i.instanceId === item.instanceId);
            if (idx === -1) return { success: false, msg: 'ç‰©å“ä¸å­˜åœ¨' };
            player.inventory.splice(idx, 1);
            // åŠ å…¥å¸‚å ´
            const market = getMarketItems();
            market.push({
                ...item,
                seller: player.username,
                price: price,
                listedTime: Date.now()
            });
            saveMarketItems(market);
            return { success: true, msg: 'ä¸Šæ¶æˆåŠŸ' };
        }

        // è³¼è²·ç‰©å“
        function buyMarketItem(marketItem) {
            const player = Game.getPlayerData();
            if (!player) return { success: false, msg: 'è«‹å…ˆç™»å…¥' };
            if (player.gold < marketItem.price) return { success: false, msg: 'é‡‘å¹£ä¸è¶³' };
            // å¾å¸‚å ´ç§»é™¤
            const market = getMarketItems();
            const idx = market.findIndex(i => i.instanceId === marketItem.instanceId);
            if (idx === -1) return { success: false, msg: 'ç‰©å“å·²å”®å‡º' };
            market.splice(idx, 1);
            saveMarketItems(market);
            // æ‰£é‡‘å¹£
            player.gold -= marketItem.price;
            // åŠ å…¥èƒŒåŒ…
            player.inventory.push(marketItem);
            return { success: true, msg: 'è³¼è²·æˆåŠŸ' };
        }

        // ---------- UI æ¸²æŸ“ ----------
        function renderForgeTab(tab) {
            const content = document.getElementById('forge-content');
            if (!content) return;
            const player = Game.getPlayerData();
            if (!player) return;

            if (tab === 'enhance') {
                // ç°¡å–®é¸æ“‡ç¬¬ä¸€ä»¶è£å‚™å¼·åŒ– (å¯æ”¹ç‚ºä¸‹æ‹‰)
                const equip = player.equipment?.weapon; // ç¤ºä¾‹
                content.innerHTML = `
                    <div class="cost-display">ğŸ”¨ å¼·åŒ–çŸ³: ${player.enhanceStone} | ğŸ’° é‡‘å¹£: ${player.gold}</div>
                    <div>é¸æ“‡è£å‚™: æ­¦å™¨ - ${equip ? equip.name : 'ç„¡'}</div>
                    <button id="do-enhance" class="modal-btn primary" ${!equip ? 'disabled' : ''}>å¼·åŒ–</button>
                    <p id="enhance-msg"></p>
                `;
                document.getElementById('do-enhance')?.addEventListener('click', () => {
                    const res = enhanceEquipment(equip);
                    document.getElementById('enhance-msg').innerText = res.msg;
                    if (res.success) {
                        Game.updateEquipmentUI();
                        renderForgeTab('enhance');
                    }
                });
            } else if (tab === 'craft') {
                let html = `<div>ææ–™: éµç¤¦: ${player.inventory?.filter(i => i.id === 'material_iron').length || 0}</div>`;
                RECIPES.forEach(recipe => {
                    html += `
                        <div class="market-item">
                            <span>${recipe.name} (éœ€ Lv.${recipe.levelRequire})</span>
                            <button class="btn-small craft-btn" data-recipe="${recipe.id}">é›é€ </button>
                        </div>
                    `;
                });
                content.innerHTML = html;
                document.querySelectorAll('.craft-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const recipeId = btn.dataset.recipe;
                        const res = craftItem(recipeId);
                        alert(res.msg);
                        if (res.success) Game.updateEquipmentUI();
                    });
                });
            } else if (tab === 'socket') {
                // ç°¡å–®ç¤ºä¾‹ï¼šé¸æ“‡æ­¦å™¨å’Œå¯¶çŸ³
                const equip = player.equipment?.weapon;
                const gems = player.gemInventory || [];
                content.innerHTML = `
                    <div>è£å‚™: ${equip ? equip.name : 'ç„¡'}</div>
                    <div class="gem-sockets" id="socket-view"></div>
                    <div>èƒŒåŒ…å¯¶çŸ³: ${gems.map(g => g.name).join(', ') || 'ç„¡'}</div>
                    <button id="do-inlay" class="modal-btn primary" ${!equip ? 'disabled' : ''}>é‘²åµŒ (æ¶ˆè€—1é‘²åµŒç¬¦)</button>
                    <button id="do-remove" class="modal-btn secondary">æ‘˜é™¤ (æ¶ˆè€—1æ‘˜é™¤ç¬¦)</button>
                    <p>é‘²åµŒç¬¦: ${player.inlayScroll} | æ‘˜é™¤ç¬¦: ${player.removeScroll}</p>
                `;
                // æ¸²æŸ“æ§½ä½
                const socketDiv = document.getElementById('socket-view');
                if (equip) {
                    const sockets = player.gemSockets[equip.instanceId] || [];
                    for (let i = 0; i < getEquipmentSockets(equip); i++) {
                        const gem = sockets[i];
                        const div = document.createElement('div');
                        div.className = `socket ${gem ? 'filled' : ''}`;
                        div.innerText = gem ? 'ğŸ’' : `æ§½${i+1}`;
                        div.dataset.socket = i;
                        socketDiv.appendChild(div);
                    }
                }
                // äº‹ä»¶ç°¡åŒ–ï¼šç›´æ¥ä½¿ç”¨ç¬¬ä¸€å€‹å¯¶çŸ³é‘²åµŒåˆ°ç¬¬ä¸€å€‹ç©ºæ§½
                document.getElementById('do-inlay')?.addEventListener('click', () => {
                    if (!equip) return;
                    const firstGem = player.gemInventory?.[0];
                    if (!firstGem) { alert('ç„¡å¯¶çŸ³'); return; }
                    const sockets = player.gemSockets[equip.instanceId] || [];
                    const emptyIdx = sockets.findIndex(s => !s);
                    if (emptyIdx === -1) { alert('æ§½å·²æ»¿'); return; }
                    const res = inlayGem(equip, firstGem, emptyIdx);
                    alert(res.msg);
                    if (res.success) { Game.updateEquipmentUI(); renderForgeTab('socket'); }
                });
                document.getElementById('do-remove')?.addEventListener('click', () => {
                    if (!equip) return;
                    const sockets = player.gemSockets[equip.instanceId] || [];
                    const filledIdx = sockets.findIndex(s => s);
                    if (filledIdx === -1) { alert('ç„¡å¯¶çŸ³å¯æ‘˜é™¤'); return; }
                    const res = removeGem(equip, filledIdx);
                    alert(res.msg);
                    if (res.success) { Game.updateEquipmentUI(); renderForgeTab('socket'); }
                });
            }
        }

        function renderMarketTab(isSell) {
            const content = document.getElementById('market-content');
            if (!content) return;
            const player = Game.getPlayerData();
            if (!player) return;

            if (isSell) {
                // é¡¯ç¤ºèƒŒåŒ…ç‰©å“ï¼Œå¯ä¸Šæ¶
                const inv = player.inventory || [];
                let html = '<h3>é¸æ“‡ç‰©å“ä¸Šæ¶</h3>';
                inv.forEach(item => {
                    html += `
                        <div class="market-item">
                            <span>${item.name}</span>
                            <input type="number" id="price-${item.instanceId}" placeholder="åƒ¹æ ¼" min="1" value="10" style="width:80px;">
                            <button class="btn-small list-btn" data-id="${item.instanceId}">ä¸Šæ¶</button>
                        </div>
                    `;
                });
                content.innerHTML = html;
                document.querySelectorAll('.list-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const instanceId = btn.dataset.id;
                        const item = player.inventory.find(i => i.instanceId === instanceId);
                        const priceInput = document.getElementById(`price-${instanceId}`);
                        const price = parseInt(priceInput.value);
                        if (isNaN(price) || price <= 0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆåƒ¹æ ¼'); return; }
                        const res = listItem(item, price);
                        alert(res.msg);
                        if (res.success) { Game.updateEquipmentUI(); renderMarketTab(true); }
                    });
                });
            } else {
                // é¡¯ç¤ºå¸‚å ´ç‰©å“ï¼Œå¯è³¼è²·
                const market = getMarketItems();
                let html = '<h3>å¸‚å ´ç‰©å“</h3>';
                market.forEach(item => {
                    html += `
                        <div class="market-item">
                            <span>${item.name} (è³£å®¶: ${item.seller})</span>
                            <span>ğŸ’° ${item.price}</span>
                            <button class="btn-small buy-btn" data-id="${item.instanceId}">è³¼è²·</button>
                        </div>
                    `;
                });
                content.innerHTML = html;
                document.querySelectorAll('.buy-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const instanceId = btn.dataset.id;
                        const marketItem = getMarketItems().find(i => i.instanceId === instanceId);
                        if (!marketItem) { alert('ç‰©å“ä¸å­˜åœ¨'); return; }
                        const res = buyMarketItem(marketItem);
                        alert(res.msg);
                        if (res.success) { Game.updateEquipmentUI(); renderMarketTab(false); }
                    });
                });
            }
        }

        // ---------- ç¶å®šäº‹ä»¶ ----------
        function bindUI() {
            document.getElementById('open-forge-btn')?.addEventListener('click', () => {
                document.getElementById('forge-modal').classList.remove('hidden');
                renderForgeTab('enhance');
            });
            document.getElementById('close-forge')?.addEventListener('click', () => {
                document.getElementById('forge-modal').classList.add('hidden');
            });
            document.querySelectorAll('[data-forge-tab]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('[data-forge-tab]').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    renderForgeTab(e.target.dataset.forgeTab);
                });
            });

            document.getElementById('open-market-btn')?.addEventListener('click', () => {
                document.getElementById('market-modal').classList.remove('hidden');
                renderMarketTab(true);
            });
            document.getElementById('close-market')?.addEventListener('click', () => {
                document.getElementById('market-modal').classList.add('hidden');
            });
            document.getElementById('market-sell-tab')?.addEventListener('click', () => {
                document.getElementById('market-sell-tab').classList.add('active');
                document.getElementById('market-buy-tab').classList.remove('active');
                renderMarketTab(true);
            });
            document.getElementById('market-buy-tab')?.addEventListener('click', () => {
                document.getElementById('market-buy-tab').classList.add('active');
                document.getElementById('market-sell-tab').classList.remove('active');
                renderMarketTab(false);
            });
        }

        // ---------- æ“´å……åˆå§‹åŒ– ----------
        const origInit = Game.init;
        Game.init = function() {
            if (origInit) origInit.call(this);
            ensureForgeMaterials();
            bindUI();
        };

        // ç¢ºä¿ recalcPlayerAttributes å­˜åœ¨ (å¯èƒ½å·²åœ¨ç¬¬äºŒæ¬¡è¼¸å‡ºå®šç¾©ï¼Œè‹¥ç„¡å‰‡ç°¡å–®å®šç¾©)
        if (typeof window.recalcPlayerAttributes !== 'function') {
            window.recalcPlayerAttributes = function() {
                const player = Game.getPlayerData();
                if (!player) return;
                // ç°¡å–®é‡æ–°è¨ˆç®— (çœç•¥å¯¶çŸ³åŠ æˆï¼Œå¯¦éš›æ‡‰åŠ ä¸Š)
                // æ­¤è™•å¯è¤‡è£½ç¬¬äºŒæ¬¡è¼¸å‡ºä¸­çš„ recalcPlayerAttributes å¯¦ç¾ï¼Œä½†ç‚ºäº†è¡Œæ•¸ï¼Œå‡å®šå·²å­˜åœ¨ã€‚
            };
        }
    })();
</script>
<!-- ========== è¿½åŠ åˆ° <style> æ¨™ç±¤å…§ ========== -->
<style>
    .pet-card {
        background: #1d2b38;
        border-radius: 20px;
        padding: 16px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 16px;
        border: 2px solid #4f6883;
    }
    .pet-avatar {
        width: 60px;
        height: 60px;
        background: #2d4055;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
    }
    .pet-info {
        flex: 1;
    }
    .pet-name {
        font-size: 1.2rem;
        font-weight: bold;
        color: #ecd69e;
    }
    .pet-stats {
        display: flex;
        gap: 16px;
        font-size: 0.8rem;
        margin-top: 6px;
    }
    .pet-ability {
        background: #1e3347;
        border-radius: 30px;
        padding: 4px 12px;
    }
    .offline-reward {
        background: #1e2e3f;
        border-radius: 20px;
        padding: 20px;
        text-align: center;
        margin: 20px 0;
    }
    .reward-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #3f5568;
    }
</style>

<!-- ========== è¿½åŠ åˆ°ç‹€æ…‹æ¬„æŒ‰éˆ•ç¾¤çµ„ (å·²æœ‰å•†åŸã€åˆæˆã€éµåŒ é‹ªã€é»‘å¸‚ï¼Œå†è¿½åŠ å…©å€‹) ========== -->
<!-- è«‹åœ¨ç¬¬å››æ¬¡è¼¸å‡ºè¿½åŠ çš„æŒ‰éˆ•ç¾¤çµ„å…§å†å¢åŠ å…©å€‹æŒ‰éˆ• -->
<div style="display:flex; gap:8px;">
    <button id="open-pet-btn">ğŸ• å¯µç‰©</button>
    <button id="open-offline-btn">â³ é›¢ç·šæ›æ©Ÿ</button>
</div>

<!-- ========== è¿½åŠ æ¨¡æ…‹æ¡†ï¼šå¯µç‰©ç³»çµ± ========== -->
<div id="pet-modal" class="modal hidden">
    <div class="modal-card modal-lg">
        <h2>ğŸ¾ å¯µç‰©å¤¥ä¼´</h2>
        <div id="pet-list" style="max-height: 300px; overflow-y: auto;">
            <!-- å‹•æ…‹ç”Ÿæˆå¯µç‰©å¡ç‰‡ -->
        </div>
        <div class="modal-actions">
            <button class="modal-btn primary" id="pet-summon">å¬å–šå¯µç‰© (100é‡‘å¹£)</button>
            <button class="modal-btn secondary" id="close-pet">é—œé–‰</button>
        </div>
    </div>
</div>

<!-- ========== è¿½åŠ æ¨¡æ…‹æ¡†ï¼šé›¢ç·šæ›æ©Ÿ ========== -->
<div id="offline-modal" class="modal hidden">
    <div class="modal-card modal-lg">
        <h2>â³ é›¢ç·šæ›æ©Ÿ</h2>
        <div id="offline-content">
            <!-- å‹•æ…‹å…§å®¹ -->
        </div>
        <div class="modal-actions">
            <button class="modal-btn primary" id="offline-claim">é ˜å–æ”¶ç›Š</button>
            <button class="modal-btn secondary" id="close-offline">é—œé–‰</button>
        </div>
    </div>
</div>

<!-- ========== è¿½åŠ åˆ° <script> å€åŸŸ ========== -->
<script>
    (function() {
        const Game = window.Game;
        if (!Game) return;

        // ---------- åˆå§‹åŒ–å¯µç‰©å’Œé›¢ç·šæ•¸æ“š ----------
        function ensurePetData() {
            const player = Game.getPlayerData?.();
            if (player) {
                if (!player.pets) player.pets = [];                 // å¯µç‰©åˆ—è¡¨
                if (!player.activePet) player.activePet = null;      // ç•¶å‰å‡ºæˆ°å¯µç‰©ID
                if (!player.lastOfflineTime) player.lastOfflineTime = Date.now(); // æœ€å¾Œè¨˜éŒ„æ™‚é–“
                if (!player.offlineReward) player.offlineReward = { exp: 0, gold: 0, items: [] }; // ç´¯ç©é›¢ç·šæ”¶ç›Š
            }
        }

        // ---------- å¯µç‰©ç”Ÿæˆï¼ˆéš¨æ©Ÿè³‡è³ªï¼‰ ----------
        const PET_NAMES = ['å°ç«é¾', 'æ°´éˆ', 'å²©é¾œ', 'é¢¨é·¹', 'å…‰çƒ', 'æš—å½±'];
        function generateRandomPet() {
            const name = PET_NAMES[Math.floor(Math.random() * PET_NAMES.length)];
            // éš¨æ©Ÿè³‡è³ª (0.8~1.5)
            constèµ„è´¨ = {
                attack: 0.8 + Math.random() * 0.7,
                defense: 0.8 + Math.random() * 0.7,
                hp: 0.8 + Math.random() * 0.7,
            };
            // åŸºç¤ç­‰ç´š1
            return {
                id: `pet_${Date.now()}_${Math.random()}`,
                name: name,
                level: 1,
                exp: 0,
                expNext: 100,
                èµ„è´¨: èµ„è´¨,
                // å±¬æ€§ç”±è³‡è³ªå’Œç­‰ç´šè¨ˆç®—
                getAttack: function() { return Math.floor(10 * this.level * this.èµ„è´¨.attack); },
                getDefense: function() { return Math.floor(8 * this.level * this.èµ„è´¨.defense); },
                getHp: function() { return Math.floor(50 * this.level * this.èµ„è´¨.hp); },
            };
        }

        // å¬å–šå¯µç‰©
        function summonPet() {
            const player = Game.getPlayerData();
            if (!player) return { success: false, msg: 'è«‹å…ˆç™»å…¥' };
            if (player.gold < 100) return { success: false, msg: 'é‡‘å¹£ä¸è¶³' };
            player.gold -= 100;
            const newPet = generateRandomPet();
            player.pets.push(newPet);
            return { success: true, msg: `ç²å¾— ${newPet.name}ï¼`, pet: newPet };
        }

        // å¯µç‰©å‡ºæˆ°/ä¼‘æ¯
        function setActivePet(petId) {
            const player = Game.getPlayerData();
            if (!player) return;
            if (petId === null) {
                player.activePet = null;
            } else {
                const pet = player.pets.find(p => p.id === petId);
                if (pet) player.activePet = petId;
            }
        }

        // å¯µç‰©ç²å¾—ç¶“é©—
        function petAddExp(pet, amount) {
            pet.exp += amount;
            while (pet.exp >= pet.expNext) {
                pet.level++;
                pet.exp -= pet.expNext;
                pet.expNext = Math.floor(pet.expNext * 1.3);
            }
        }

        // ---------- é›¢ç·šæ›æ©Ÿè¨ˆç®— ----------
        function calculateOfflineReward() {
            const player = Game.getPlayerData();
            if (!player) return { exp: 0, gold: 0, items: [] };
            const now = Date.now();
            const last = player.lastOfflineTime || now;
            const diffSeconds = Math.floor((now - last) / 1000);
            // æœ€å¤šè¨ˆç®— 8 å°æ™‚ (28800ç§’)
            const cappedSeconds = Math.min(diffSeconds, 28800);
            if (cappedSeconds < 60) return { exp: 0, gold: 0, items: [] }; // å°‘æ–¼1åˆ†é˜ç„¡æ”¶ç›Š

            // æ¯åˆ†é˜æ”¶ç›Š
            const expPerMin = 5 * (player.level || 1);
            const goldPerMin = 2 * (player.level || 1);
            const minutes = Math.floor(cappedSeconds / 60);

            const expGain = expPerMin * minutes;
            const goldGain = goldPerMin * minutes;

            // éš¨æ©Ÿç‰©å“æ‰è½ (æ¯10åˆ†é˜æ¦‚ç‡)
            const items = [];
            if (minutes >= 10) {
                for (let i = 0; i < Math.floor(minutes / 10); i++) {
                    if (Math.random() < 0.3) { // 30%æ¦‚ç‡æ‰è½
                        items.push({
                            name: 'é›¢ç·šå¯¶ç®±',
                            type: 'treasure',
                            instanceId: `offline_${Date.now()}_${i}`,
                        });
                    }
                }
            }
            return { exp: expGain, gold: goldGain, items };
        }

        // é ˜å–é›¢ç·šæ”¶ç›Š
        function claimOffline() {
            const player = Game.getPlayerData();
            if (!player) return { success: false, msg: 'è«‹å…ˆç™»å…¥' };
            const reward = calculateOfflineReward();
            if (reward.exp === 0 && reward.gold === 0 && reward.items.length === 0) {
                return { success: false, msg: 'æ²’æœ‰æ”¶ç›Šå¯é ˜å–' };
            }
            // åŠ ç¶“é©— (è§’è‰²)
            if (typeof Game.addExp === 'function') {
                Game.addExp(reward.exp);
            } else {
                player.exp += reward.exp;
                // ç°¡æ˜“å‡ç´šæª¢æŸ¥ (å¯è¤‡è£½ä¹‹å‰é‚è¼¯)
                while (player.exp >= player.expNext) {
                    player.level++;
                    player.exp -= player.expNext;
                    player.expNext = Math.floor(player.expNext * 1.2);
                }
            }
            player.gold = (player.gold || 0) + reward.gold;
            // æ·»åŠ ç‰©å“
            reward.items.forEach(item => {
                player.inventory.push(item);
            });
            // æ›´æ–°æœ€å¾Œè¨˜éŒ„æ™‚é–“ç‚ºç¾åœ¨
            player.lastOfflineTime = Date.now();
            return { success: true, msg: `ç²å¾— ${reward.exp} ç¶“é©—ã€${reward.gold} é‡‘å¹£ã€${reward.items.length} å€‹ç‰©å“`, reward };
        }

        // ---------- UI æ¸²æŸ“ ----------
        function renderPets() {
            const container = document.getElementById('pet-list');
            if (!container) return;
            const player = Game.getPlayerData();
            if (!player) return;
            const pets = player.pets || [];
            container.innerHTML = '';
            pets.forEach(pet => {
                const card = document.createElement('div');
                card.className = 'pet-card';
                const isActive = player.activePet === pet.id;
                card.innerHTML = `
                    <div class="pet-avatar">ğŸ‰</div>
                    <div class="pet-info">
                        <div class="pet-name">${pet.name} ${isActive ? '(å‡ºæˆ°)' : ''}</div>
                        <div class="pet-stats">
                            <span>æ”» ${pet.getAttack()}</span>
                            <span>é˜² ${pet.getDefense()}</span>
                            <span>è¡€ ${pet.getHp()}</span>
                        </div>
                        <div class="pet-ability">è³‡è³ª: ${pet.èµ„è´¨.attack.toFixed(2)}/${pet.èµ„è´¨.defense.toFixed(2)}/${pet.èµ„è´¨.hp.toFixed(2)}</div>
                    </div>
                    <button class="btn-small" data-pet-id="${pet.id}">${isActive ? 'ä¼‘æ¯' : 'å‡ºæˆ°'}</button>
                `;
                card.querySelector('button').addEventListener('click', () => {
                    if (isActive) {
                        setActivePet(null);
                    } else {
                        setActivePet(pet.id);
                    }
                    renderPets();
                });
                container.appendChild(card);
            });
        }

        function renderOffline() {
            const content = document.getElementById('offline-content');
            if (!content) return;
            const player = Game.getPlayerData();
            if (!player) return;
            const reward = calculateOfflineReward();
            content.innerHTML = `
                <div class="offline-reward">
                    <h3>é›¢ç·šæ™‚é–“æ”¶ç›Š</h3>
                    <div class="reward-item"><span>ç¶“é©—</span><span>${reward.exp}</span></div>
                    <div class="reward-item"><span>é‡‘å¹£</span><span>${reward.gold}</span></div>
                    <div class="reward-item"><span>ç‰©å“</span><span>${reward.items.map(i => i.name).join(', ') || 'ç„¡'}</span></div>
                    <p style="margin-top:16px;">æœ€å¾Œè¨˜éŒ„: ${new Date(player.lastOfflineTime).toLocaleString()}</p>
                </div>
            `;
        }

        // ---------- ç¶å®šäº‹ä»¶ ----------
        function bindUI() {
            document.getElementById('open-pet-btn')?.addEventListener('click', () => {
                document.getElementById('pet-modal').classList.remove('hidden');
                renderPets();
            });
            document.getElementById('close-pet')?.addEventListener('click', () => {
                document.getElementById('pet-modal').classList.add('hidden');
            });
            document.getElementById('pet-summon')?.addEventListener('click', () => {
                const res = summonPet();
                alert(res.msg);
                if (res.success) {
                    Game.updateEquipmentUI(); // åˆ·æ–°é‡‘å¹£é¡¯ç¤º
                    renderPets();
                }
            });

            document.getElementById('open-offline-btn')?.addEventListener('click', () => {
                document.getElementById('offline-modal').classList.remove('hidden');
                renderOffline();
            });
            document.getElementById('close-offline')?.addEventListener('click', () => {
                document.getElementById('offline-modal').classList.add('hidden');
            });
            document.getElementById('offline-claim')?.addEventListener('click', () => {
                const res = claimOffline();
                alert(res.msg);
                if (res.success) {
                    Game.updateEquipmentUI(); // åˆ·æ–°é‡‘å¹£ç¶“é©—
                    renderOffline();
                }
            });
        }

        // ---------- æ“´å……åˆå§‹åŒ–ï¼šè¨˜éŒ„é›¢ç·šæ™‚é–“ ----------
        const origInit = Game.init;
        Game.init = function() {
            if (origInit) origInit.call(this);
            ensurePetData();
            bindUI();
            // æ¯æ¬¡åˆå§‹åŒ–ï¼ˆåŒ…å«ç™»å…¥ï¼‰æ™‚æ›´æ–°æœ€å¾Œè¨˜éŒ„æ™‚é–“ç‚ºç•¶å‰æ™‚é–“ï¼ˆé¿å…é‡è¤‡è¨ˆç®—ï¼‰
            const player = Game.getPlayerData?.();
            if (player) {
                player.lastOfflineTime = Date.now();
            }
        };

        // æ“´å……ç™»å‡ºæ™‚æ›´æ–°é›¢ç·šæ™‚é–“ï¼ˆä½†ç™»å‡ºæ™‚å·²ç¶“ä¿å­˜éï¼Œä¸‹æ¬¡ç™»å…¥æœƒè‡ªå‹•è¨˜éŒ„æ–°æ™‚é–“ï¼Œæ•…ç„¡éœ€ç‰¹æ®Šè™•ç†ï¼‰
        // ç‚ºäº†ç¢ºä¿é›¢ç·šè¨ˆç®—æº–ç¢ºï¼Œæˆ‘å€‘åœ¨æ¯æ¬¡å•Ÿå‹•æ™‚ï¼ˆåŒ…æ‹¬é é¢åˆ·æ–°ï¼‰è¨˜éŒ„æ™‚é–“ï¼Œé€™å·²åœ¨initä¸­å®Œæˆã€‚

        // ç‚ºäº†è®“å¯µç‰©å±¬æ€§å½±éŸ¿æˆ°é¬¥ï¼ˆå¯é¸ï¼‰ï¼Œæˆ‘å€‘å¯ä»¥æ“´å……æˆ°é¬¥å‡½æ•¸ï¼Œä½†æœ¬æ¬¡å…ˆä¸å¯¦ä½œï¼Œåƒ…å±•ç¤ºå¯µç‰©ç³»çµ±ã€‚
    })();
</script>
<!-- ========== è¿½åŠ åˆ° <style> æ¨™ç±¤å…§ ========== -->
<style>
    .engrave-card, .glyph-card, .mastery-card {
        background: #1d2e3d;
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 12px;
        border: 1px solid #5a7595;
    }
    .resource-row {
        display: flex;
        justify-content: space-between;
        background: #0f1a24;
        padding: 8px 16px;
        border-radius: 30px;
        margin: 10px 0;
    }
    .mastery-tree {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin: 20px 0;
        flex-wrap: wrap;
    }
    .mastery-node {
        background: #25384b;
        width: 100px;
        height: 100px;
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border: 2px solid #6f8db0;
        cursor: pointer;
        transition: 0.2s;
    }
    .mastery-node.learned {
        border-color: #ffaa33;
        background: #3e5f7a;
    }
    .mastery-node:hover {
        transform: scale(1.05);
        background: #2f4a66;
    }
</style>

<!-- ========== è¿½åŠ åˆ°ç‹€æ…‹æ¬„æŒ‰éˆ•ç¾¤çµ„ (ç¹¼çºŒå¢åŠ ä¸‰å€‹æŒ‰éˆ•) ========== -->
<!-- è«‹åœ¨ç¬¬äº”æ¬¡è¼¸å‡ºè¿½åŠ çš„æŒ‰éˆ•ç¾¤çµ„å…§å†å¢åŠ ä¸‰å€‹æŒ‰éˆ• -->
<div style="display:flex; gap:8px;">
    <button id="open-engrave-btn">âš™ï¸ éŠ˜åˆ»</button>
    <button id="open-glyph-btn">ğŸ”® é›•æ–‡</button>
    <button id="open-mastery-btn">ğŸ“š ç²¾é€š</button>
</div>

<!-- ========== è¿½åŠ æ¨¡æ…‹æ¡†ï¼šéŠ˜åˆ»ç³»çµ± ========== -->
<div id="engrave-modal" class="modal hidden">
    <div class="modal-card modal-lg">
        <h2>âš™ï¸ è£å‚™éŠ˜åˆ»</h2>
        <div class="resource-row">
            <span>ğŸ”¨ éŠ˜åˆ»çŸ³: <span id="engrave-stone-count">0</span></span>
            <span>ğŸ’° é‡‘å¹£: <span id="engrave-gold">0</span></span>
        </div>
        <div id="engrave-content">
            <!-- å‹•æ…‹å…§å®¹ -->
        </div>
        <div class="modal-actions">
            <button class="modal-btn secondary" id="close-engrave">é—œé–‰</button>
        </div>
    </div>
</div>

<!-- ========== è¿½åŠ æ¨¡æ…‹æ¡†ï¼šé›•æ–‡ç³»çµ± ========== -->
<div id="glyph-modal" class="modal hidden">
    <div class="modal-card modal-lg">
        <h2>ğŸ”® é›•æ–‡é‘²åµŒ</h2>
        <div class="resource-row">
            <span>ğŸ§© é›•æ–‡ç¢ç‰‡: <span id="glyph-shard-count">0</span></span>
            <span>ğŸ’° é‡‘å¹£: <span id="glyph-gold">0</span></span>
        </div>
        <div id="glyph-content">
            <!-- å‹•æ…‹å…§å®¹ -->
        </div>
        <div class="modal-actions">
            <button class="modal-btn secondary" id="close-glyph">é—œé–‰</button>
        </div>
    </div>
</div>

<!-- ========== è¿½åŠ æ¨¡æ…‹æ¡†ï¼šç²¾é€šç³»çµ± ========== -->
<div id="mastery-modal" class="modal hidden">
    <div class="modal-card modal-lg">
        <h2>ğŸ“š è§’è‰²ç²¾é€š</h2>
        <div class="resource-row">
            <span>ğŸ“– ç²¾é€šé»æ•¸: <span id="mastery-points">0</span></span>
            <span>ğŸ“Š ç•¶å‰ç²¾é€šç­‰ç´š: <span id="mastery-level">0</span></span>
        </div>
        <div id="mastery-tree" class="mastery-tree">
            <!-- å‹•æ…‹ç”Ÿæˆç²¾é€šç¯€é» -->
        </div>
        <div class="modal-actions">
            <button class="modal-btn secondary" id="close-mastery">é—œé–‰</button>
        </div>
    </div>
</div>

<!-- ========== è¿½åŠ åˆ° <script> å€åŸŸ ========== -->
<script>
    (function() {
        const Game = window.Game;
        if (!Game) return;

        // ---------- åˆå§‹åŒ–æ–°è³‡æº ----------
        function ensureNewResources() {
            const player = Game.getPlayerData?.();
            if (player) {
                if (player.engraveStone === undefined) player.engraveStone = 3;    // éŠ˜åˆ»çŸ³
                if (player.glyphShard === undefined) player.glyphShard = 5;        // é›•æ–‡ç¢ç‰‡
                if (player.masteryPoints === undefined) player.masteryPoints = 0;  // ç²¾é€šé»æ•¸
                if (player.masteryLevel === undefined) player.masteryLevel = 1;    // ç²¾é€šç­‰ç´š (ç”¨æ–¼è§£é–ç¯€é»)
                if (!player.engraveData) player.engraveData = {};                  // è£å‚™éŠ˜åˆ»è¨˜éŒ„ { [equipId]: { level: 1, stat: 'attack', value: 5 } }
                if (!player.glyphData) player.glyphData = {};                      // è£å‚™é›•æ–‡è¨˜éŒ„ { [equipId]: [ { slot:0, type:'crit', value:3 } ] }
                if (!player.masteryNodes) player.masteryNodes = [];                // å·²å­¸ç¿’ç²¾é€šç¯€é»
            }
        }

        // ---------- éŠ˜åˆ»ç³»çµ± ----------
        function engraveEquipment(equip) {
            if (!equip) return { success: false, msg: 'è«‹é¸æ“‡è£å‚™' };
            const player = Game.getPlayerData();
            const costStone = 2;
            const costGold = 200;
            if (player.engraveStone < costStone) return { success: false, msg: 'éŠ˜åˆ»çŸ³ä¸è¶³' };
            if (player.gold < costGold) return { success: false, msg: 'é‡‘å¹£ä¸è¶³' };
            // ç²å–ç•¶å‰éŠ˜åˆ»ç­‰ç´š
            const current = player.engraveData[equip.instanceId] || { level: 0, stat: 'attack', value: 0 };
            const nextLevel = current.level + 1;
            if (nextLevel > 10) return { success: false, msg: 'å·²é”æœ€å¤§éŠ˜åˆ»ç­‰ç´š' };
            // éŠ˜åˆ»æ•ˆæœï¼šæ¯ç´šå¢åŠ æ”»æ“Š+2ï¼ˆå¯æ”¹ç‚ºæ ¹æ“šè£å‚™é¡å‹ï¼‰
            const newValue = current.value + 2;
            player.engraveData[equip.instanceId] = { level: nextLevel, stat: 'attack', value: newValue };
            player.engraveStone -= costStone;
            player.gold -= costGold;
            // é‡æ–°è¨ˆç®—å±¬æ€§ï¼ˆéœ€æ“´å…… recalc å‡½æ•¸ï¼‰
            if (typeof window.recalcPlayerAttributes === 'function') window.recalcPlayerAttributes();
            return { success: true, msg: `éŠ˜åˆ»æˆåŠŸï¼${equip.name} æ”»æ“Š +2 (ç¸½è¨ˆ +${newValue})` };
        }

        // ---------- é›•æ–‡ç³»çµ± ----------
        function inlayGlyph(equip, slotIndex, glyphType) {
            const player = Game.getPlayerData();
            if (!equip) return { success: false, msg: 'è«‹é¸æ“‡è£å‚™' };
            if (!player.glyphShard || player.glyphShard < 3) return { success: false, msg: 'é›•æ–‡ç¢ç‰‡ä¸è¶³ (éœ€3å€‹)' };
            // å‡è¨­æ¯å€‹è£å‚™æœ‰2å€‹é›•æ–‡æ§½
            if (!player.glyphData[equip.instanceId]) player.glyphData[equip.instanceId] = [];
            if (player.glyphData[equip.instanceId].length >= 2) return { success: false, msg: 'é›•æ–‡æ§½å·²æ»¿' };
            if (player.glyphData[equip.instanceId][slotIndex]) return { success: false, msg: 'è©²æ§½å·²æœ‰é›•æ–‡' };
            // éš¨æ©Ÿç”Ÿæˆé›•æ–‡å±¬æ€§
            const glyphs = [
                { type: 'critRate', value: 3 },
                { type: 'critDamage', value: 10 },
                { type: 'hit', value: 5 },
                { type: 'dodge', value: 3 }
            ];
            const chosen = glyphs[Math.floor(Math.random() * glyphs.length)];
            player.glyphData[equip.instanceId][slotIndex] = chosen;
            player.glyphShard -= 3;
            if (typeof window.recalcPlayerAttributes === 'function') window.recalcPlayerAttributes();
            return { success: true, msg: `é‘²åµŒ ${chosen.type} +${chosen.value} æˆåŠŸ` };
        }

        // ---------- ç²¾é€šç³»çµ± ----------
        const MASTERY_NODES = [
            { id: 'node1', name: 'æ”»æ“Šå¼·åŒ–', stat: 'attack', bonus: 5, requireLevel: 1, cost: 1 },
            { id: 'node2', name: 'é˜²ç¦¦å¼·åŒ–', stat: 'defense', bonus: 4, requireLevel: 2, cost: 1 },
            { id: 'node3', name: 'æš´æ“Šå°ˆç²¾', stat: 'critRate', bonus: 2, requireLevel: 3, cost: 2 },
            { id: 'node4', name: 'æš´å‚·å°ˆç²¾', stat: 'critDamage', bonus: 15, requireLevel: 4, cost: 2 },
        ];

        function learnMasteryNode(nodeId) {
            const player = Game.getPlayerData();
            const node = MASTERY_NODES.find(n => n.id === nodeId);
            if (!node) return { success: false, msg: 'ç¯€é»ä¸å­˜åœ¨' };
            if (player.masteryLevel < node.requireLevel) return { success: false, msg: 'ç²¾é€šç­‰ç´šä¸è¶³' };
            if (player.masteryPoints < node.cost) return { success: false, msg: 'ç²¾é€šé»æ•¸ä¸è¶³' };
            if (player.masteryNodes.includes(nodeId)) return { success: false, msg: 'å·²å­¸ç¿’' };
            player.masteryNodes.push(nodeId);
            player.masteryPoints -= node.cost;
            // å¢åŠ ç²¾é€šç­‰ç´šï¼ˆå¯é¸ï¼šå­¸ç¿’ç¯€é»æå‡ç­‰ç´šï¼‰
            // é‡æ–°è¨ˆç®—å±¬æ€§
            if (typeof window.recalcPlayerAttributes === 'function') window.recalcPlayerAttributes();
            return { success: true, msg: `å­¸ç¿’ ${node.name} æˆåŠŸ` };
        }

        // ç²¾é€šé»æ•¸å¯é€šéç¶“é©—è½‰åŒ–ï¼ˆä¾‹å¦‚æ¯1000ç¶“é©—ç²å¾—1é»ï¼‰
        function convertExpToMastery(expAmount) {
            const player = Game.getPlayerData();
            if (player.exp < expAmount) return { success: false, msg: 'ç¶“é©—ä¸è¶³' };
            player.exp -= expAmount;
            player.masteryPoints += Math.floor(expAmount / 1000);
            return { success: true, msg: 'è½‰åŒ–æˆåŠŸ' };
        }

        // ---------- UI æ¸²æŸ“ ----------
        function renderEngrave() {
            const content = document.getElementById('engrave-content');
            if (!content) return;
            const player = Game.getPlayerData();
            if (!player) return;
            document.getElementById('engrave-stone-count').textContent = player.engraveStone;
            document.getElementById('engrave-gold').textContent = player.gold;

            // ç°¡å–®é¡¯ç¤ºæ­¦å™¨å¯éŠ˜åˆ»
            const weapon = player.equipment?.weapon;
            const engraveInfo = weapon ? (player.engraveData[weapon.instanceId] || { level: 0, value: 0 }) : null;
            content.innerHTML = `
                <div class="engrave-card">
                    <div>ç•¶å‰æ­¦å™¨: ${weapon ? weapon.name : 'ç„¡'}</div>
                    ${weapon ? `<div>éŠ˜åˆ»ç­‰ç´š: ${engraveInfo.level} (æ”»æ“Š +${engraveInfo.value})</div>` : ''}
                    <button id="do-engrave" class="modal-btn primary" ${!weapon ? 'disabled' : ''}>éŠ˜åˆ» (æ¶ˆè€—2çŸ³+200é‡‘)</button>
                </div>
            `;
            document.getElementById('do-engrave')?.addEventListener('click', () => {
                const res = engraveEquipment(weapon);
                alert(res.msg);
                if (res.success) {
                    Game.updateEquipmentUI();
                    renderEngrave();
                }
            });
        }

        function renderGlyph() {
            const content = document.getElementById('glyph-content');
            if (!content) return;
            const player = Game.getPlayerData();
            if (!player) return;
            document.getElementById('glyph-shard-count').textContent = player.glyphShard;
            document.getElementById('glyph-gold').textContent = player.gold;

            const weapon = player.equipment?.weapon;
            const glyphs = weapon ? (player.glyphData[weapon.instanceId] || []) : [];
            let html = `<div>ç•¶å‰æ­¦å™¨: ${weapon ? weapon.name : 'ç„¡'}</div>`;
            if (weapon) {
                for (let i = 0; i < 2; i++) {
                    const glyph = glyphs[i];
                    html += `<div>é›•æ–‡æ§½ ${i+1}: ${glyph ? glyph.type + '+' + glyph.value : 'ç©º'} 
                        <button class="btn-small" data-slot="${i}" ${glyph ? 'disabled' : ''}>é‘²åµŒ</button></div>`;
                }
            }
            content.innerHTML = html;
            document.querySelectorAll('[data-slot]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const slot = btn.dataset.slot;
                    const res = inlayGlyph(weapon, parseInt(slot));
                    alert(res.msg);
                    if (res.success) {
                        Game.updateEquipmentUI();
                        renderGlyph();
                    }
                });
            });
        }

        function renderMastery() {
            const player = Game.getPlayerData();
            if (!player) return;
            document.getElementById('mastery-points').textContent = player.masteryPoints;
            document.getElementById('mastery-level').textContent = player.masteryLevel;

            const treeDiv = document.getElementById('mastery-tree');
            treeDiv.innerHTML = '';
            MASTERY_NODES.forEach(node => {
                const learned = player.masteryNodes.includes(node.id);
                const div = document.createElement('div');
                div.className = `mastery-node ${learned ? 'learned' : ''}`;
                div.innerHTML = `
                    <div>${node.name}</div>
                    <div>${node.stat}+${node.bonus}</div>
                    <div>éœ€æ±‚Lv.${node.requireLevel}</div>
                `;
                div.addEventListener('click', () => {
                    if (learned) { alert('å·²å­¸ç¿’'); return; }
                    const res = learnMasteryNode(node.id);
                    alert(res.msg);
                    if (res.success) renderMastery();
                });
                treeDiv.appendChild(div);
            });
        }

        // ---------- ç¶å®šäº‹ä»¶ ----------
        function bindUI() {
            document.getElementById('open-engrave-btn')?.addEventListener('click', () => {
                document.getElementById('engrave-modal').classList.remove('hidden');
                renderEngrave();
            });
            document.getElementById('close-engrave')?.addEventListener('click', () => {
                document.getElementById('engrave-modal').classList.add('hidden');
            });

            document.getElementById('open-glyph-btn')?.addEventListener('click', () => {
                document.getElementById('glyph-modal').classList.remove('hidden');
                renderGlyph();
            });
            document.getElementById('close-glyph')?.addEventListener('click', () => {
                document.getElementById('glyph-modal').classList.add('hidden');
            });

            document.getElementById('open-mastery-btn')?.addEventListener('click', () => {
                document.getElementById('mastery-modal').classList.remove('hidden');
                renderMastery();
            });
            document.getElementById('close-mastery')?.addEventListener('click', () => {
                document.getElementById('mastery-modal').classList.add('hidden');
            });
        }

        // ---------- æ“´å……åˆå§‹åŒ– ----------
        const origInit = Game.init;
        Game.init = function() {
            if (origInit) origInit.call(this);
            ensureNewResources();
            bindUI();
        };

        // æ“´å……å±¬æ€§è¨ˆç®—ï¼šåŠ å…¥éŠ˜åˆ»ã€é›•æ–‡ã€ç²¾é€šç¯€é»åŠ æˆ
        // å‡è¨­å·²æœ‰ recalcPlayerAttributesï¼Œæˆ‘å€‘å¯ä»¥ monkey patch æˆ–è¦†è“‹
        const origRecalc = window.recalcPlayerAttributes;
        window.recalcPlayerAttributes = function() {
            if (origRecalc) origRecalc(); // å…ˆè¨ˆç®—åŸæœ‰å±¬æ€§
            const player = Game.getPlayerData();
            if (!player) return;
            // éŠ˜åˆ»åŠ æˆ
            for (let equipId in player.engraveData) {
                const engrave = player.engraveData[equipId];
                if (engrave && engrave.stat) {
                    player.attributes[engrave.stat] = (player.attributes[engrave.stat] || 0) + engrave.value;
                }
            }
            // é›•æ–‡åŠ æˆ
            for (let equipId in player.glyphData) {
                player.glyphData[equipId].forEach(glyph => {
                    if (glyph && glyph.type) {
                        player.attributes[glyph.type] = (player.attributes[glyph.type] || 0) + glyph.value;
                    }
                });
            }
            // ç²¾é€šç¯€é»åŠ æˆ
            player.masteryNodes.forEach(nodeId => {
                const node = MASTERY_NODES.find(n => n.id === nodeId);
                if (node) {
                    player.attributes[node.stat] = (player.attributes[node.stat] || 0) + node.bonus;
                }
            });
        };
    })();
</script>
</body>
</html>